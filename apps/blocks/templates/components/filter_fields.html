{# expects:
   - filter_schema: dict of key -> {label, type, help?, choices?, multiple?}
   - initial_values: dict of key -> value (or list for multiselect)
#}
{% load dict_extras static %}

{% for key, cfg in filter_schema.items %}
  {% with val=initial_values|get_item:key %}
  <div class="mb-3">
    <label class="form-label">{{ cfg.label }}</label>

    {% if cfg.type == 'select' %}
      <select class="form-select" name="{{ name_prefix|default:'filters.' }}{{ key }}">
        <option value="">-- Any --</option>
        {% for v, lbl in cfg.choices %}
          <option value="{{ v }}" {% if val|stringformat:"s" == v|stringformat:"s" %}selected{% endif %}>
            {{ lbl }}
          </option>
        {% endfor %}
      </select>

    {% elif cfg.type == 'multiselect' %}
      <select class="form-select" name="{{ name_prefix|default:'filters.' }}{{ key }}" multiple>
        {% for v, lbl in cfg.choices %}
          <option value="{{ v }}" {% if val and v in val %}selected{% endif %}>
            {{ lbl }}
          </option>
        {% endfor %}
      </select>
      <div class="form-text">Hold Ctrl/Cmd to select multiple.</div>

    {% elif cfg.type == 'autocomplete' %}
      {% include "autocomplete_light/static.html" %}
      <select class="form-select"
              data-autocomplete-light-url="{{ cfg.url }}"
              data-autocomplete-light-function="select2"
              {% if cfg.forward %}data-autocomplete-light-forward="{{ cfg.forward }}"{% endif %}
              name="{{ name_prefix|default:'filters.' }}{{ key }}"
              {% if cfg.multiple %}multiple{% endif %}>
        {% if val %}
          {% if cfg.multiple %}
            {% for v in val %}
              <option value="{{ v }}" selected></option>
            {% endfor %}
          {% else %}
            <option value="{{ val }}" selected></option>
          {% endif %}
        {% endif %}
      </select>

    {% elif cfg.type == 'number' %}
      <input type="number" class="form-control" name="{{ name_prefix|default:'filters.' }}{{ key }}" value="{{ val|default:'' }}"/>

    {% elif cfg.type == 'date' %}
      <input type="date" class="form-control" name="{{ name_prefix|default:'filters.' }}{{ key }}" value="{{ val|default:'' }}"/>

    {% elif cfg.type == 'boolean' %}
      <div class="form-check">
        <input type="checkbox" class="form-check-input" id="{{ id_prefix|default:'' }}-filters_{{ key }}"
               name="{{ name_prefix|default:'filters.' }}{{ key }}" value="1" {% if val %}checked{% endif %}>
        <label class="form-check-label" for="{{ id_prefix|default:'' }}-filters_{{ key }}">Yes</label>
      </div>

    {% else %}
      {# default to text #}
      <input type="text" class="form-control" name="{{ name_prefix|default:'filters.' }}{{ key }}" value="{{ val|default:'' }}"/>
    {% endif %}

    {% if cfg.help %}
      <div class="form-text">{{ cfg.help }}</div>
    {% endif %}
  </div>
  {% endwith %}
{% endfor %}
