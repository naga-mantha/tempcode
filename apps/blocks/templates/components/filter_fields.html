{# expects:
   - filter_schema: dict of key -> {label, type, help?, choices?, multiple?, tom_select_options?}
   - initial_values: dict of key -> value (or list for multiselect)
#}
{% load dict_extras static %}

{% for key, cfg in filter_schema.items %}
  {% with val=initial_values|get_item:key %}
  <div class="mb-3">
    <label class="form-label">{{ cfg.label }}</label>

    {% if cfg.type == 'select' %}
      <select class="form-select filter-field-select" name="{{ name_prefix|default:'filters.' }}{{ key }}"{% if cfg.choices_url %} data-ajax-url="{{ cfg.choices_url }}"{% endif %}{% if cfg.tom_select_options %} data-tom-select-options='{{ cfg.tom_select_options|tojson }}'{% endif %}>
        <option value="">-- Any --</option>
        {% if not cfg.choices_url %}
          {% for v, lbl in cfg.choices %}
            <option value="{{ v }}" {% if val|stringformat:"s" == v|stringformat:"s" %}selected{% endif %}>
              {{ lbl }}
            </option>
          {% endfor %}
        {% elif val %}
          {# for AJAX selects, include current value so Tom Select can display it #}
          <option value="{{ val }}" selected>{{ val }}</option>
        {% endif %}
      </select>

    {% elif cfg.type == 'multiselect' %}
      <select class="form-select filter-field-select" name="{{ name_prefix|default:'filters.' }}{{ key }}" multiple{% if cfg.choices_url %} data-ajax-url="{{ cfg.choices_url }}"{% endif %}{% if cfg.tom_select_options %} data-tom-select-options='{{ cfg.tom_select_options|tojson }}'{% endif %}>
        {% if not cfg.choices_url %}
          {% for v, lbl in cfg.choices %}
            <option value="{{ v }}" {% if val and v in val %}selected{% endif %}>
              {{ lbl }}
            </option>
          {% endfor %}
        {% elif val %}
          {% for v in val %}
            <option value="{{ v }}" selected>{{ v }}</option>
          {% endfor %}
        {% else %}
          <option value=""></option>
        {% endif %}
      </select>
      <div class="form-text">Hold Ctrl/Cmd to select multiple.</div>

    {% elif cfg.type == 'number' %}
      <input type="number" class="form-control" name="{{ name_prefix|default:'filters.' }}{{ key }}" value="{{ val|default:'' }}"/>

    {% elif cfg.type == 'date' %}
      <input type="date" class="form-control" name="{{ name_prefix|default:'filters.' }}{{ key }}" value="{{ val|default:'' }}"/>

    {% elif cfg.type == 'boolean' %}
      <div class="form-check">
        <input type="checkbox" class="form-check-input" id="{{ id_prefix|default:'' }}-filters_{{ key }}"
               name="{{ name_prefix|default:'filters.' }}{{ key }}" value="1" {% if val %}checked{% endif %}>
        <label class="form-check-label" for="{{ id_prefix|default:'' }}-filters_{{ key }}">Yes</label>
      </div>

    {% else %}
      {# default to text #}
      <input type="text" class="form-control" name="{{ name_prefix|default:'filters.' }}{{ key }}" value="{{ val|default:'' }}"/>
    {% endif %}

    {% if cfg.help %}
      <div class="form-text">{{ cfg.help }}</div>
    {% endif %}
  </div>
  {% endwith %}
{% endfor %}

<script>
  // Initialize Tom Select only on actual <select> elements and guard parsing.
  document.querySelectorAll('select.filter-field-select').forEach(function(el){
    try {
      if (!el || el.tagName !== 'SELECT') return;
      if (el.dataset.tomInitialized) return;
      el.dataset.tomInitialized = '1';

      const ajaxUrl = el.dataset.ajaxUrl;
      const settings = { persist: false, maxOptions: 100 };

      if (el.multiple) {
        settings.plugins = ['remove_button'];
      }

      if (ajaxUrl) {
        settings.valueField = 'value';
        settings.labelField = 'label';
        settings.searchField = 'label';
        settings.preload = true;
        settings.shouldLoad = () => true;
        settings.load = function(query, callback){
          const url = ajaxUrl + (query ? ('?q=' + encodeURIComponent(query)) : '');
          fetch(url).then(r => r.json()).then(callback).catch(() => callback());
        };
      }

      let extraOpts = {};
      if (el.dataset.tomSelectOptions) {
        try { extraOpts = JSON.parse(el.dataset.tomSelectOptions) || {}; } catch (e) { extraOpts = {}; }
      }

      const ts = new TomSelect(el, { ...settings, ...extraOpts });
      if (ts && typeof ts.setTextboxValue === 'function') {
        ts.on('item_add', () => ts.setTextboxValue(''));
      }
    } catch (e) {
      // Fail-safe: do not block page if a single field fails to initialize
      // console.warn('TomSelect init failed', e);
    }
  });
</script>
