<!--{# expects:-->
<!--   - filter_schema: dict of key -> {label, type, help?, choices?, multiple?, tom_select_options?}-->
<!--   - initial_values: dict of key -> value (or list for multiselect)-->
<!--#}-->
{% load dict_extras static %}

{% for key, cfg in filter_schema.items %}
  {% with val=initial_values|get_item:key %}
  <div class="mb-4 filter-field">
    <label class="form-label">{{ cfg.label }}</label>

    {% if cfg.type == 'select' %}
      <select class="form-select filter-field-select" name="{{ name_prefix|default:'filters.' }}{{ key }}"{% if cfg.choices_url %} data-ajax-url="{{ cfg.choices_url }}"{% endif %}{% if cfg.tom_select_options %} data-tom-select-options='{{ cfg.tom_select_options|tojson }}'{% endif %}>
        <option value="">-- Any --</option>
        {% if not cfg.choices_url %}
          {% for v, lbl in cfg.choices %}
            <option value="{{ v }}" {% if val|stringformat:"s" == v|stringformat:"s" %}selected{% endif %}>
              {{ lbl }}
            </option>
          {% endfor %}
        {% elif val %}
          {# for AJAX selects, include current value so Tom Select can display it #}
          <option value="{{ val }}" selected>{{ val }}</option>
        {% endif %}
      </select>

    {% elif cfg.type == 'multiselect' %}
      <select class="form-select filter-field-select" name="{{ name_prefix|default:'filters.' }}{{ key }}" multiple{% if cfg.choices_url %} data-ajax-url="{{ cfg.choices_url }}"{% endif %}{% if cfg.tom_select_options %} data-tom-select-options='{{ cfg.tom_select_options|tojson }}'{% endif %}>
        {% if not cfg.choices_url %}
          {% for v, lbl in cfg.choices %}
            <option value="{{ v }}" {% if val and v in val %}selected{% endif %}>
              {{ lbl }}
            </option>
          {% endfor %}
        {% elif val %}
          {% for v in val %}
            <option value="{{ v }}" selected>{{ v }}</option>
          {% endfor %}
        {% else %}
          <option value=""></option>
        {% endif %}
      </select>
      <div class="form-text">Hold Ctrl/Cmd to select multiple.</div>

    {% elif cfg.type == 'number' %}
      <input type="number" class="form-control" name="{{ name_prefix|default:'filters.' }}{{ key }}" value="{{ val|default:'' }}"/>

    {% elif cfg.type == 'date' %}
      <div class="date-filter-wrapper" data-key="{{ key }}">
        <div class="d-flex gap-2 align-items-start flex-wrap">
          <input type="text" class="form-control date-token-input" style="min-width: 220px;"
                 name="{{ name_prefix|default:'filters.' }}{{ key }}"
                 value="{{ val|default:'' }}"
                 placeholder="YYYY-MM-DD or token"/>
          <div>
            <button class="btn btn-outline-secondary btn-sm pick-date-btn" type="button">Pick Date</button>
            <input type="date" class="date-picker" style="position:absolute;opacity:0;width:0;height:0;pointer-events:none;" tabindex="-1" aria-hidden="true"/>
          </div>
          <select class="form-select form-select-sm date-quick-select" style="min-width: 200px;">
            <option value="">Quick pickâ€¦</option>
            <option value="__today__">Today</option>
            <option value="__start_of_month__">Start of Month</option>
            <option value="__end_of_month__">End of Month</option>
            <option value="__start_of_quarter__">Start of Quarter</option>
            <option value="__end_of_quarter__">End of Quarter</option>
            <option value="__start_of_year__">Start of Year</option>
            <option value="__end_of_year__">End of Year</option>
            <option value="__current_fiscal_year_start__">Current FY Start</option>
            <option value="__current_fiscal_year_end__">Current FY End</option>
          </select>
        </div>
      </div>

    {% elif cfg.type == 'boolean' %}
      <div class="form-check">
        <input type="checkbox" class="form-check-input" id="{{ id_prefix|default:'' }}-filters_{{ key }}"
               name="{{ name_prefix|default:'filters.' }}{{ key }}" value="1" {% if val %}checked{% endif %}>
        <label class="form-check-label" for="{{ id_prefix|default:'' }}-filters_{{ key }}">Yes</label>
      </div>

    {% else %}
      {# default to text #}
      <input type="text" class="form-control" name="{{ name_prefix|default:'filters.' }}{{ key }}" value="{{ val|default:'' }}"/>
    {% endif %}

    {% if cfg.help %}
      <div class="form-text">{{ cfg.help }}</div>
    {% endif %}
  </div>
  {% endwith %}
{% endfor %}

<script>
  // Initialize Tom Select only on actual <select> elements and guard parsing.
  document.querySelectorAll('select.filter-field-select').forEach(function(el){
    try {
      if (!el || el.tagName !== 'SELECT') return;
      if (el.dataset.tomInitialized) return;
      el.dataset.tomInitialized = '1';

      const ajaxUrl = el.dataset.ajaxUrl;
      const settings = { persist: false, maxOptions: 100 };

      if (el.multiple) {
        settings.plugins = ['remove_button'];
      }

      if (ajaxUrl) {
        settings.valueField = 'value';
        settings.labelField = 'label';
        settings.searchField = 'label';
        settings.preload = true;
        settings.shouldLoad = () => true;
        settings.load = function(query, callback){
          const url = ajaxUrl + (query ? ('?q=' + encodeURIComponent(query)) : '');
          fetch(url).then(r => r.json()).then(callback).catch(() => callback());
        };
      }

      let extraOpts = {};
      if (el.dataset.tomSelectOptions) {
        try { extraOpts = JSON.parse(el.dataset.tomSelectOptions) || {}; } catch (e) { extraOpts = {}; }
      }

      const ts = new TomSelect(el, { ...settings, ...extraOpts });
      if (ts && typeof ts.setTextboxValue === 'function') {
        ts.on('item_add', () => ts.setTextboxValue(''));
      }

      // If there are preselected values and this is an AJAX select,
      // fetch their labels explicitly so the control shows code+name (not raw IDs).
      if (ajaxUrl) {
        const selectedValues = Array.from(el.options).filter(o => o.selected && o.value !== '').map(o => o.value);
        if (selectedValues.length > 0) {
          const url = ajaxUrl + '?ids=' + encodeURIComponent(selectedValues.join(','));
          fetch(url)
            .then(r => r.ok ? r.json() : [])
            .then(list => {
              if (!list || !Array.isArray(list)) return;
              list.forEach(opt => {
                try {
                  ts.addOption(opt);
                  ts.updateOption(opt.value, opt);
                } catch (e) { /* ignore */ }
              });
              // Re-add selected items to ensure labels refresh
              selectedValues.forEach(v => { try { ts.addItem(v, true); } catch (e) {} });
            })
            .catch(() => {});
        }
      }
    } catch (e) {
      // Fail-safe: do not block page if a single field fails to initialize
      // console.warn('TomSelect init failed', e);
    }
  });

  // Wire up date pickers + quick tokens to the date text input
  document.querySelectorAll('.date-filter-wrapper').forEach(function(wrap){
    try {
      const textInput = wrap.querySelector('.date-token-input');
      const hiddenPicker = wrap.querySelector('.date-picker');
      const pickBtn = wrap.querySelector('.pick-date-btn');
      const quickSel = wrap.querySelector('.date-quick-select');
      pickBtn?.addEventListener('click', function(){ hiddenPicker?.showPicker ? hiddenPicker.showPicker() : hiddenPicker?.click(); });
      hiddenPicker?.addEventListener('change', function(){ if (textInput) textInput.value = hiddenPicker.value || ''; });
      quickSel?.addEventListener('change', function(){ if (quickSel.value && textInput) { textInput.value = quickSel.value; } });
    } catch(e) {}
  });
</script>
<style>
  /* Ensure consistent spacing under each filter field */
  .filter-field { margin-bottom: 1rem; }
  /* In case of tight containers, enforce bottom spacing */
  .filter-field:last-child { margin-bottom: 1rem; }
  /* Compact spacing for inline controls within date fields */
  .date-filter-wrapper .form-text { margin-top: 0.25rem; }
  .date-filter-wrapper .btn.pick-date-btn { white-space: nowrap; }
</style>
