{% load static %}
<link href="https://unpkg.com/tabulator-tables@6.2.1/dist/css/tabulator.min.css" rel="stylesheet">
<script src="https://unpkg.com/tabulator-tables@6.2.1/dist/js/tabulator.min.js"></script>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <label class="me-2">View:</label>
    <select id="column-config-select-{{ block_name }}-{{ instance_id }}" class="form-select d-inline-block w-auto me-2">
      {% for cfg in column_configs %}
        <option value="{{ cfg.id }}" {% if cfg.id == active_column_config_id %}selected{% endif %}>
          {{ cfg.name }}
        </option>
      {% endfor %}
    </select>
    <a class="btn btn-link p-0" href="{% url 'column_config_view' block_name %}">Manage Views</a>
    <a class="btn btn-link p-0 ms-2" href="{% url 'render_table_block' block_name %}">Table Link</a>
  </div>
<div>
    <label class="me-2">Filter:</label>
    <select id="filter-config-select-{{ block_name }}-{{ instance_id }}" class="form-select d-inline-block w-auto">
      <option value="">-- None --</option>
      {% for f in filter_configs %}
        <option value="{{ f.id }}" {% if f.id == active_filter_config_id %}selected{% endif %}>
          {{ f.name }}{% if f.is_default %} (default){% endif %}
        </option>
      {% endfor %}
    </select>
    <a class="btn btn-link p-0 ms-2" href="{% url 'table_filter_config' block_name %}">Manage Filters</a>
  </div>

</div>

{# Live (non-persistent) filter fields; pre-populated from selected saved filter #}
<form method="get" id="dynamic-filters-form-{{ block_name }}-{{ instance_id }}" class="mb-3">
  {# preserve current selections when applying live overrides #}
  {% if active_column_config_id %}
    <input type="hidden" name="{{ block_name }}__{{ instance_id }}__column_config_id" value="{{ active_column_config_id }}">
  {% endif %}
  {% if active_filter_config_id %}
    <input type="hidden" name="{{ block_name }}__{{ instance_id }}__filter_config_id" value="{{ active_filter_config_id }}">
  {% endif %}

  <details class="border rounded">
    <summary class="p-2 bg-light" style="cursor:pointer;font-weight:bold">
      Filter Conditions
    </summary>
    <div class="p-3">
      {# Renders actual inputs based on your schema #}
      {% include "components/filter_fields.html" with filter_schema=filter_schema initial_values=selected_filter_values name_prefix=block_name|add:"__"|add:instance_id|add:"__filters." id_prefix=block_name|add:"-"|add:instance_id %}
      <button type="submit" class="btn btn-primary mt-2">Apply Filters</button>
    </div>
  </details>
</form>

<div id="table-{{ block_name }}-{{ instance_id }}"></div>

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // 1) Initialize the table
    const tableEl = document.getElementById("table-{{ block_name }}-{{ instance_id }}");
    // adjust columns to enforce per-row editability using __editable flags
    const baseColumns = {{ columns|safe }};
    const columns = baseColumns.map(col => {
      if (col.editor) {
        col.editable = function(cell){
          const data = cell.getRow().getData();
          const f = cell.getColumn().getField();
          return data && data.__editable && data.__editable[f] === true;
        };
      }
      return col;
    });

    const table = new Tabulator(tableEl, {
      layout: "fitColumns",
      data:{{ data|safe }},
      columns:columns,
      ...{{ tabulator_options|safe }},  // ensure trailing comma
    });

    // 3) Inline editing: send changes to server
    table.on("cellEdited", function(cell){
      const row = cell.getRow();
      const id = row.getData().id;
      const field = cell.getField();
      const value = cell.getValue();
      if (id == null) { return; }
      fetch("{% url 'inline_edit' block_name %}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({id, field, value}),
      }).then(res => res.json()).then(resp => {
        if (!resp.success) {
          alert(resp.error || "Update failed");
          cell.restoreOldValue();
        }
      }).catch(() => {
        alert("Network error while saving");
        cell.restoreOldValue();
      });
    });

    // helper to preserve both column_config_id and filter_config_id in URL
    function setSearchParams(params) {
      const url = new URL(window.location.href);
      Object.entries(params).forEach(([k, v]) => {
        if (v === "" || v === null || v === undefined) url.searchParams.delete(k);
        else url.searchParams.set(k, v);
      });
      window.location.href = url.toString();
    }
    function clearNamespacedFilters(urlObj){
      const nsPrefix = "{{ block_name }}__{{ instance_id }}__filters.";
      const toDelete = [];
      for (const [k] of urlObj.searchParams.entries()){
        if (k.startsWith(nsPrefix)) toDelete.push(k);
      }
      toDelete.forEach(k => urlObj.searchParams.delete(k));
    }

    // 2) Keep both selections when switching either dropdown
    const colSelect = document.getElementById("column-config-select-{{ block_name }}-{{ instance_id }}");
    const filtSelect = document.getElementById("filter-config-select-{{ block_name }}-{{ instance_id }}");
    colSelect?.addEventListener("change", function() {
      const filterId = filtSelect?.value || "";
      setSearchParams({ "{{ block_name }}__{{ instance_id }}__column_config_id": this.value, "{{ block_name }}__{{ instance_id }}__filter_config_id": filterId });
    });

    filtSelect?.addEventListener("change", function() {
      const url = new URL(window.location.href);
      // Clear any ad-hoc filter overrides so saved config values show
      clearNamespacedFilters(url);
      const columnKey = "{{ block_name }}__{{ instance_id }}__column_config_id";
      const filterKey = "{{ block_name }}__{{ instance_id }}__filter_config_id";
      const columnId = colSelect?.value || url.searchParams.get(columnKey) || "";
      if (columnId) url.searchParams.set(columnKey, columnId); else url.searchParams.delete(columnKey);
      if (this.value) url.searchParams.set(filterKey, this.value); else url.searchParams.delete(filterKey);
      window.location.href = url.toString();
    });
  });
</script>
{% endblock %}
