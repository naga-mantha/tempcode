{% extends "base.html" %}
{% load dict_extras %}
{% block content %}
<h2>Manage Filters for {{ block_title }}</h2>

<!-- Dropdown to load/edit existing filters (no page reload) -->
<div class="mb-3">
  <label for="filter-select">Select Filter:</label>
  <select id="filter-select" class="form-select d-inline-block w-auto">
    <option value="">-- New Filter --</option>
    {% for f in configs %}
      <option value="{{ f.id }}" data-name="{{ f.name|escape }}">{{ f.name }}{% if f.is_default %} (default){% endif %}</option>
    {% endfor %}
  </select>
  <button id="reset-filter-form" type="button" class="btn btn-link">Clear</button>
  </div>

<!-- Filter definition form -->
<form id="filter-form" method="post" action="{% url 'table_filter_config' route_block_name %}">
  {% csrf_token %}
  <input type="hidden" name="action" value="create">

  <div class="mb-3">
    <label for="filter-name">Filter Name:</label>
    <input type="text" name="name" id="filter-name" required class="form-control d-inline-block w-auto">
    <button type="submit" class="btn btn-primary">Save Filter</button>
  </div>

  <details class="border rounded mb-3" open>
    <summary class="p-2 bg-light" style="cursor: pointer; font-weight: bold;">
      Filter Conditions
    </summary>
    <div class="p-3">
      {% include "components/filter_fields.html" with filter_schema=filter_schema initial_values=initial_values %}
    </div>
  </details>
</form>

<!-- Existing filters table -->
<h3 class="mt-5">Saved Filters</h3>
<table class="table mt-2">
  <thead>
    <tr>
      <th>Name</th>
      <th>Values</th>
      <th>Default</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for config in configs %}
    <tr>
      <td>{{ config.name }}</td>
      <td>
        {% with items=configs_values_by_id|get_item:config.id %}
          {% if items %}{{ items|join:"<br>"|safe }}{% endif %}
        {% endwith %}
      </td>
      <td>{% if config.is_default %}âœ”{% endif %}</td>
      <td>
        <form method="post" style="display:inline-block" action="{% url 'table_filter_config' route_block_name %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="set_default">
          <input type="hidden" name="config_id" value="{{ config.id }}">
          <button type="submit" class="btn btn-sm btn-outline-primary">Set Default</button>
        </form>
        {% if configs|length > 1 %}
        <form method="post" style="display:inline-block" action="{% url 'table_filter_config' route_block_name %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="delete">
          <input type="hidden" name="config_id" value="{{ config.id }}">
          <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?')">Delete</button>
        </form>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
  </table>

<script>
  // Schema choice labels provided by server for select-like fields
  let schemaLabels = {};
  try { schemaLabels = {{ schema_choice_labels_json|safe }} || {}; } catch (e) { schemaLabels = {}; }

  function setFieldValueByName(form, name, value) {
    const selector = '[name="' + name.replace(/([\\[\\].])/g, '\\$1') + '"]';
    const els = form.querySelectorAll(selector);
    els.forEach(el => {
      const tag = el.tagName.toLowerCase();
      if (tag === 'select') {
        const ts = el.tomselect;
        const isMultiple = el.hasAttribute('multiple');
        const key = name.indexOf('filters.') === 0 ? name.slice('filters.'.length) : name;
        const labelMap = schemaLabels[key] || {};
        function ensureOption(val){
          const valStr = String(val);
          const label = labelMap[valStr] || valStr;
          if (ts) {
            ts.addOption({value: valStr, label: label});
          } else {
            let opt = Array.from(el.options).find(o => String(o.value) === valStr);
            if (!opt) {
              opt = document.createElement('option');
              opt.value = valStr;
              opt.textContent = label;
              el.appendChild(opt);
            }
            opt.selected = true;
          }
        }
        if (ts) {
          ts.clear(true);
          ts.clearOptions();
          if (isMultiple && Array.isArray(value)) {
            value.forEach(v => ensureOption(v));
            ts.setValue(value, true);
          } else if (value != null && value !== '') {
            ensureOption(value);
            ts.setValue(String(value), true);
          }
        } else {
          if (isMultiple && Array.isArray(value)) {
            Array.from(el.options).forEach(o => o.selected = false);
            value.forEach(v => ensureOption(v));
          } else {
            Array.from(el.options).forEach(o => o.selected = false);
            if (value != null && value !== '') ensureOption(value);
            else el.value = '';
          }
        }
      } else if (el.type === 'checkbox') {
        el.checked = Boolean(value);
      } else {
        el.value = value == null ? '' : String(value);
      }
    });
  }

  function populateFilterForm(values) {
    const form = document.getElementById('filter-form');
    if (!values || typeof values !== 'object') return;
    Object.entries(values).forEach(([k, v]) => {
      setFieldValueByName(form, `filters.${k}`, v);
    });
  }

  function clearFilterForm() {
    const form = document.getElementById('filter-form');
    form.reset();
    form.querySelectorAll('select').forEach(sel => {
      if (sel.tomselect) {
        sel.tomselect.clear();
      } else if (sel.multiple) {
        Array.from(sel.options).forEach(o => o.selected = false);
      } else {
        sel.value = '';
      }
    });
  }

  const select = document.getElementById('filter-select');
  const nameInput = document.getElementById('filter-name');
  let valuesById = {};
  try {
    const scriptData = {{ configs_values_json|safe }};
    valuesById = scriptData || {};
  } catch (e) { valuesById = {}; }
  function cleanOptionText(txt){
    const suffix = ' (default)';
    if (txt && txt.endsWith(suffix)) return txt.slice(0, -suffix.length);
    return txt || '';
  }

  function handleSelectChange(){
    const opt = select.options[select.selectedIndex];
    const dsName = opt?.dataset?.name || '';
    const textName = cleanOptionText(opt?.textContent || '');
    const name = dsName || textName;
    const selectedId = select.value;
    const values = valuesById[selectedId] || {};
    clearFilterForm();
    nameInput.value = name === '-- New Filter --' ? '' : name;
    populateFilterForm(values);
  }

  select?.addEventListener('change', handleSelectChange);
  // Initialize form if a selection is pre-chosen by browser
  if (select && select.value) { handleSelectChange(); }

  document.getElementById('reset-filter-form')?.addEventListener('click', () => {
    select.value = '';
    clearFilterForm();
    nameInput.value = '';
  });

  document.getElementById('filter-form').addEventListener('submit', function (e) {
    const name = nameInput.value.trim();
    if (!name) {
      e.preventDefault();
      alert('Please enter a name for this filter.');
    }
  });
</script>
{% endblock %}
