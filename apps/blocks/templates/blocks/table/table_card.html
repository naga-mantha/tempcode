{% load dict_extras %}

<script type="application/json" id="table-config-{{ dom_id }}">
  {{ frontend_config|tojson }}
</script>

<div id="{{ dom_wrapper_id }}" class="card shadow-sm" data-table-root="{{ dom_id }}">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div class="fw-semibold">{{ title }}</div>
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <label class="mb-0 small text-muted">View</label>
      <select class="form-select form-select-sm w-auto" onchange="(function(sel){ try{ var params=new URLSearchParams(window.location.search||''); var key='config_id__{{ dom_id }}'; if(sel.value){ params.set(key, sel.value);} else { params.delete(key); } var dest=window.location.pathname + (params.toString() ? ('?'+params.toString()) : ''); window.location.assign(dest); }catch(e){ var key='config_id__{{ dom_id }}'; var base=window.location.pathname + '?' + encodeURIComponent(key) + '='; window.location.href= base + encodeURIComponent(sel.value||''); } })(this)">
        <option value="">(Default)</option>
        {% if table_configs %}
          <optgroup label="Private views">
            {% for cfg in table_configs %}
              {% if cfg.user_id == request.user.id and cfg.visibility == 'private' %}
                <option value="{{ cfg.id }}" {% if cfg.id == active_table_config_id %}selected{% endif %}>{{ cfg.name }}</option>
              {% endif %}
            {% endfor %}
          </optgroup>
          <optgroup label="Public views">
            {% for cfg in table_configs %}
              {% if cfg.visibility == 'public' %}
                <option value="{{ cfg.id }}" {% if cfg.id == active_table_config_id %}selected{% endif %}>{{ cfg.name }}</option>
              {% endif %}
            {% endfor %}
          </optgroup>
        {% endif %}
      </select>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'blocks:manage_columns' spec_id %}">Table Settings</a>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'blocks:render_spec' spec_id %}">Table Link</a>
      <span class="mx-1 text-muted">&mdash;</span>
      <label class="mb-0 small text-muted">Filter</label>
      <select id="filterCfgSelect-{{ dom_id }}" class="form-select form-select-sm w-auto" data-filter-select data-dom-id="{{ dom_id }}">
        <option value="">(None)</option>
        {% if filter_configs %}
          <optgroup label="Private filters">
            {% for cfg in filter_configs %}
              {% if cfg.user_id == request.user.id and cfg.visibility == 'private' %}
                <option value="{{ cfg.id }}" {% if cfg.id == active_filter_config_id %}selected{% endif %}>{{ cfg.name }}{% if cfg.is_default %} (default){% endif %}</option>
              {% endif %}
            {% endfor %}
          </optgroup>
          <optgroup label="Public filters">
            {% for cfg in filter_configs %}
              {% if cfg.visibility == 'public' %}
                <option value="{{ cfg.id }}" {% if cfg.id == active_filter_config_id %}selected{% endif %}>{{ cfg.name }}{% if cfg.is_default %} (default){% endif %}</option>
              {% endif %}
            {% endfor %}
          </optgroup>
        {% endif %}
      </select>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'blocks:manage_filters' spec_id %}">Filter Settings</a>
      <span class="mx-1 text-muted">&mdash;</span>
      <div class="btn-group" role="group" aria-label="Exports">
        <button type="button"
                class="btn btn-sm btn-outline-secondary"
                data-export-excel
                data-dom-id="{{ dom_id }}">
          Export Excel
        </button>
        <button type="button"
                class="btn btn-sm btn-outline-secondary"
                data-export-pdf
                data-dom-id="{{ dom_id }}">
          Export PDF
        </button>
      </div>
    </div>
  </div>
  <div class="card-body">
    <div class="htmx-indicator spinner-border spinner-border-sm text-secondary" role="status" style="display:none"></div>
    <form id="tableFilterForm-{{ dom_id }}" data-filter-form data-dom-id="{{ dom_id }}">
      <input type="hidden" name="config_id" value="{{ active_table_config_id|default:'' }}">
      <input type="hidden" name="filter_config_id" value="{{ active_filter_config_id|default:'' }}">
      <div class="accordion mb-3" id="accordion-{{ dom_id }}">
        <div class="accordion-item">
          <h2 class="accordion-header" id="heading-{{ dom_id }}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ dom_id }}" aria-expanded="false" aria-controls="collapse-{{ dom_id }}">
              Filter Conditions
            </button>
          </h2>
          {% include "blocks/filter/_active_badges.html" with badges=active_filter_badges %}
          <div id="collapse-{{ dom_id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ dom_id }}" data-bs-parent="#accordion-{{ dom_id }}">
            <div class="accordion-body">
              {% if filter_schema %}
                {% include "components/filter_fields.html" with filter_schema=filter_schema initial_values=filters filter_layout=filter_layout name_prefix="" id_prefix=dom_id %}
                <div class="mt-2">
                  <button type="submit" class="btn btn-sm btn-primary">Apply Filters</button>
                </div>
              {% else %}
                <div class="text-muted small">No filter schema defined.</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </form>

    <div id="{{ dom_table_id }}" class="border rounded" style="height: 520px;"></div>
    <noscript>
      <div class="text-muted small mt-3">Enable JavaScript to view the interactive table.</div>
    </noscript>
  </div>
</div>

