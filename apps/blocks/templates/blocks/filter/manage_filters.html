{% extends "base.html" %}

{% block title %}<title>Manage Filters — {{ spec.name }}</title>{% endblock %}

{% block content %}
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h5 class="mb-0">Manage Filters — {{ spec.name }}</h5>
    <div class="d-flex align-items-center gap-2">
      <label class="mb-0 small text-muted">Load Filter</label>
      <form method="get" class="d-inline m-0 p-0">
        <select name="filter_config_id" class="form-select form-select-sm w-auto"
                onchange="(function(sel){ if(!sel.value){ sel.setAttribute('data-old-name', sel.getAttribute('name')); sel.removeAttribute('name'); } sel.form.requestSubmit(); })(this)">
          <option value="">New (default)</option>
          {% if filter_configs %}
            <optgroup label="Private filters">
              {% for cfg in filter_configs %}
                {% if cfg.user_id == request.user.id and cfg.visibility == 'private' %}
                  <option value="{{ cfg.id }}" {% if cfg.id == active_filter_config_id %}selected{% endif %}>{{ cfg.name }}</option>
                {% endif %}
              {% endfor %}
            </optgroup>
            <optgroup label="Public filters">
              {% for cfg in filter_configs %}
                {% if cfg.visibility == 'public' %}
                  <option value="{{ cfg.id }}" {% if cfg.id == active_filter_config_id %}selected{% endif %}>{{ cfg.name }}</option>
                {% endif %}
              {% endfor %}
            </optgroup>
          {% endif %}
        </select>
      </form>
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="history.back()">Back</button>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'blocks:render_spec' spec_id %}">Table Link</a>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-7">
      {% include "blocks/filter/_saved_filters.html" with spec_id=spec_id filter_configs=filter_configs %}
    </div>

    <div class="col-md-5">
      <form id="manageFilterForm" hx-post="{% url 'blocks:save_filter_config' spec_id %}" hx-swap="none">
        {% csrf_token %}
        <div class="card">
          <div class="card-header">Save Filter</div>
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-md-6">
                <label class="form-label">Name</label>
                <input type="text" name="name" class="form-control" value="{{ active_filter_name|default:'' }}" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Visibility</label>
                <select name="visibility" class="form-select">
                  <option value="private">Private</option>
                  <option value="public">Public</option>
                </select>
              </div>
              <div class="col-md-2">
                <div class="form-check mt-4">
                  <input class="form-check-input" type="checkbox" name="is_default" id="mkDefaultFilt" {% if active_filter_is_default %}checked{% endif %}>
                  <label class="form-check-label" for="mkDefaultFilt">Default</label>
                </div>
              </div>
            </div>
            <input type="hidden" name="values_json" id="manageFilterValues">
            <div class="mt-3">
              <button type="button" class="btn btn-primary" onclick="saveManageFilter()">Save Filter</button>
            </div>
          </div>
        </div>

        <div class="card mt-3">
          <div class="card-header">Filter Layout</div>
          <div class="card-body">
            <p class="text-muted small mb-2">Arrange which filter fields appear and their order.</p>
            <a class="btn btn-sm btn-outline-secondary" href="{% url 'blocks:manage_filter_layout' spec_id %}">Manage My Filter Layout</a>
            {% if request.user.is_staff %}
              <a class="btn btn-sm btn-outline-secondary ms-2" href="{% url 'blocks:manage_filter_layout_default' spec_id %}">Manage Default Layout</a>
            {% endif %}
          </div>
        </div>

        <div class="card mt-3">
          <div class="card-header">Filter Fields</div>
          <div class="card-body">
            {% if filter_schema %}
              <div id="filterFieldsPanel" class="mb-1">
                {% include "components/filter_fields.html" with filter_schema=filter_schema initial_values=initial_values filter_layout=filter_layout name_prefix="" id_prefix="mf" %}
              </div>
            {% else %}
              <div class="text-muted small">No filter schema defined for this spec.</div>
            {% endif %}
          </div>
        </div>
      </form>
    </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('htmx:afterRequest', function(ev){
    try {
      var t = ev.target;
      // After saving a new filter, reload to refresh dropdown and values
      if (t && t.id === 'manageFilterForm'){
        const note = document.createElement('div');
        note.className = 'alert alert-success position-fixed top-0 end-0 m-3';
        note.textContent = 'Saved';
        document.body.appendChild(note);
        setTimeout(function(){ note.remove(); window.location.reload(); }, 800);
        return;
      }
      if (t.classList && t.classList.contains('js-reload-on-success')){
        if (ev.detail && ev.detail.xhr && ev.detail.xhr.status >= 200 && ev.detail.xhr.status < 300){
          window.location.reload();
        }
      }
    } catch (e) {}
  });

  // Collect values and submit Save Filter
  function saveManageFilter(){
    try {
      const wrap = document.getElementById('manageFilterForm');
      const data = {};
      if (wrap){
        const fd = new FormData(wrap);
        for (let [k, v] of fd.entries()){
          if (k === 'name' || k === 'visibility' || k === 'is_default' || k === 'values_json' || k === 'csrfmiddlewaretoken') continue;
          if (v === '') continue;
          // Strip optional 'filters.' prefix used by shared templates
          if (k.startsWith('filters.')) k = k.slice(8);
          // Multiselects: accumulate values per key
          if (data[k]){
            if (!Array.isArray(data[k])) data[k] = [data[k]];
            data[k].push(v);
          } else {
            data[k] = v;
          }
        }
      }
      document.getElementById('manageFilterValues').value = JSON.stringify(data);
      document.getElementById('manageFilterForm').requestSubmit();
    } catch (e) { alert('Unable to read filter values'); }
  }

  (function(){
    // Minimal TomSelect init for AJAX choices on this page
    try {
      if (window.TomSelect){
        document.querySelectorAll('#manageFilterForm select.filter-field-select').forEach(function(sel){
          var ajaxUrl = sel.getAttribute('data-ajax-url');
          var opts = {};
          try { var raw = sel.getAttribute('data-tom-select-options'); if (raw) opts = JSON.parse(raw); } catch(e){}
          var minLen = 3;
          if (ajaxUrl){
            new TomSelect(sel, Object.assign({
              valueField: 'value',
              labelField: 'label',
              searchField: 'label',
              persist: false,
              closeAfterSelect: true,
              preload: 'focus',
              openOnFocus: true,
              placeholder: 'Type at least ' + minLen + ' characters',
              load: function(query, callback){
                if (!query || query.length < minLen) { callback(); return; }
                fetch(ajaxUrl + '?q=' + encodeURIComponent(query), {headers: {'X-Requested-With':'XMLHttpRequest'}})
                  .then(r => r.json()).then(resp => callback(resp.results || []))
                  .catch(() => callback());
              }
            }, opts));
          }
        });
      }
    } catch(e) { console.warn('TomSelect init failed', e); }
  })();
</script>
{% endblock %}
