{% extends "base.html" %}
{% block content %}

<div class="main-container">
  <h2 class="page-title">Repeater Settings for {{ block_title }}</h2>

  <div class="mb-3">
    <label for="config-select">Saved Settings:</label>
    <select id="config-select" class="form-select d-inline-block w-auto">
      <option value="">-- New --</option>
      {% for c in configs %}
        <option value="{{ c.id }}" {% if active_config and c.id == active_config.id %}selected{% endif %}>{{ c.name }}{% if c.is_default %} (default){% endif %}</option>
      {% endfor %}
    </select>
    <a href="{% url 'repeater_config_view' block_name %}" class="btn btn-link btn-sm">Clear</a>
    {% if active_config %}<span class="ms-2 text-muted">Editing: <strong>{{ active_config.name }}</strong></span>{% endif %}
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        const sel = document.getElementById('config-select');
        sel?.addEventListener('change', function(){
          const url = new URL(window.location);
          if (this.value) { url.searchParams.set('config_id', this.value); } else { url.searchParams.delete('config_id'); }
          window.location = url.toString();
        });
      });
    </script>
  </div>

  <form method="post" class="mb-4" id="repeater-config-form">
    {% csrf_token %}
    <input type="hidden" name="action" value="create">
    {% if active_config %}
      <input type="hidden" name="config_id" value="{{ active_config.id }}">
    {% endif %}

    <div class="row g-3 align-items-end mb-3">
      <div class="col-md-4">
        <label class="form-label">Name</label>
        <input type="text" name="name" class="form-control" value="{{ form.initial.name|default:'' }}" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Cols (Bootstrap span)</label>
        <select name="cols" class="form-select">
          {% for val,label in form.cols.field.choices %}
            <option value="{{ val }}" {% if form.initial.cols == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label class="form-label">Group By</label>
        <select name="group_by" class="form-select">
          {% for val,label in form.group_by.field.choices %}
            <option value="{{ val }}" {% if form.initial.group_by == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Label Field</label>
        <select name="label_field" class="form-select">
          {% for val,label in form.label_field.field.choices %}
            <option value="{{ val }}" {% if form.initial.label_field == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Include Null</label>
        <div class="form-check">
          <input type="checkbox" name="include_null" class="form-check-input" {% if form.initial.include_null %}checked{% endif %}>
        </div>
      </div>
      <div class="col-md-2">
        <label class="form-label">Limit</label>
        <input type="number" min="1" name="limit" class="form-control" value="{{ form.initial.limit|default:'' }}">
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label class="form-label">Sort</label>
        <select name="sort" class="form-select">
          {% for val,label in form.sort.field.choices %}
            <option value="{{ val }}" {% if form.initial.sort == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-8">
        <label class="form-label">Panel Title Template</label>
        <input type="text" name="title_template" class="form-control" value="{{ form.initial.title_template|default:'{label}' }}" placeholder="e.g., {label}">
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Child Filters Map (JSON)</label>
      <textarea name="child_filters_map" class="form-control" rows="4" placeholder='{"buyer": "value"}'>{{ form.initial.child_filters_map|default:'{}' }}</textarea>
      <small class="text-muted">Map child filter keys to <code>value</code>, <code>label</code>, or a literal string. Use <code>null_sentinel</code> below for null values.</small>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label class="form-label">Null Sentinel</label>
        <input type="text" name="null_sentinel" class="form-control" value="{{ form.initial.null_sentinel|default:'' }}" placeholder="e.g., __none__">
      </div>
      <div class="col-md-4">
        <label class="form-label">Child Filter Config Name</label>
        <input type="text" name="child_filter_config_name" class="form-control" value="{{ form.initial.child_filter_config_name|default:'' }}" placeholder="Optional">
      </div>
      <div class="col-md-4">
        <label class="form-label">Child Column Config Name</label>
        <input type="text" name="child_column_config_name" class="form-control" value="{{ form.initial.child_column_config_name|default:'' }}" placeholder="Optional">
      </div>
    </div>

    <div class="mt-2">
      <button type="submit" class="btn btn-primary">Save Settings</button>
    </div>
  </form>

  <h3>Saved Repeater Settings</h3>
  <table class="table mt-2">
    <thead>
      <tr>
        <th>Name</th>
        <th>Default</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for config in configs %}
      <tr>
        <td>{{ config.name }}</td>
        <td>{% if config.is_default %}âœ“{% endif %}</td>
        <td>
          <form method="post" style="display:inline-block">
            {% csrf_token %}
            <input type="hidden" name="action" value="set_default">
            <input type="hidden" name="config_id" value="{{ config.id }}">
            <button type="submit" class="btn btn-sm btn-outline-primary">Set Default</button>
          </form>
          {% if configs|length > 1 %}
          <form method="post" style="display:inline-block">
            {% csrf_token %}
            <input type="hidden" name="action" value="delete">
            <input type="hidden" name="config_id" value="{{ config.id }}">
            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?')">Delete</button>
          </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
      {% if not configs %}
      <tr><td colspan="3" class="text-muted">No saved settings yet.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>
{% endblock %}
