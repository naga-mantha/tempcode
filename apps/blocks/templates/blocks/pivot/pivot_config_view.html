{% extends "base.html" %}
{% block content %}
<h2>Pivot Settings for {{ block_title }}</h2>

<div class="mb-3">
  <label for="config-select">Saved Settings:</label>
  <select id="config-select" class="form-select d-inline-block w-auto">
    <option value="">-- New --</option>
    {% for c in configs %}
      <option value="{{ c.id }}" {% if active_config and c.id == active_config.id %}selected{% endif %}>{{ c.name }}{% if c.is_default %} (default){% endif %}</option>
    {% endfor %}
  </select>
  <a href="{% url 'pivot_config_view' block_name %}" class="btn btn-link btn-sm">Clear</a>
  {% if active_config %}<span class="ms-2 text-muted">Editing: <strong>{{ active_config.name }}</strong></span>{% endif %}
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const sel = document.getElementById('config-select');
      sel?.addEventListener('change', function(){
        const url = new URL(window.location);
        if (this.value) { url.searchParams.set('config_id', this.value); } else { url.searchParams.delete('config_id'); }
        window.location = url.toString();
      });
    });
  </script>
</div>

<form method="post" class="mb-4" id="pivot-config-form">
  {% csrf_token %}
  <input type="hidden" name="action" value="create">
  {% if active_config %}
    <input type="hidden" name="config_id" value="{{ active_config.id }}">
  {% endif %}
  <div class="row g-2 align-items-end">
    <div class="col-auto">
      <label class="form-label">Name</label>
      <input type="text" name="name" class="form-control" value="{{ form.initial.name|default:'' }}" required>
    </div>
    <div class="col-auto">
      <label class="form-label">Source</label>
      <select name="source_model" class="form-select">
        {% for key, cfg in allowed_sources.items %}
          <option value="{{ key }}" {% if form.initial.source_model == key %}selected{% endif %}>{{ key }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="w-100"></div>
    <div class="col-md-6">
      <label class="form-label">Rows</label>
      <select name="rows" class="form-select" multiple>
        {% for val,label in form.rows.field.choices %}
          <option value="{{ val }}" {% if form.initial.rows and val in form.initial.rows %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-6">
      <label class="form-label">Column</label>
      <select name="col" class="form-select">
        {% for val,label in form.col.field.choices %}
          <option value="{{ val }}" {% if form.initial.col == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <small class="text-muted">Optional; one column dimension</small>
    </div>
    <div class="col-md-4">
      <label class="form-label">Measure</label>
      <select name="measure_field" class="form-select">
        {% for val,label in form.measure_field.field.choices %}
          <option value="{{ val }}" {% if form.initial.measure_field == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <label class="form-label mt-2">Label</label>
      <input type="text" name="measure_label" class="form-control" value="{{ form.initial.measure_label|default:'' }}" placeholder="e.g., Total Quantity">
      <label class="form-label mt-2">Aggregation</label>
      <select name="measure_agg" class="form-select">
        {% for val,label in form.measure_agg.field.choices %}
          <option value="{{ val }}" {% if form.initial.measure_agg == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 mt-2">
      <button type="submit" class="btn btn-primary">Save Settings</button>
    </div>
  </div>
</form>

<h3>Saved Pivot Settings</h3>
<table class="table mt-2">
  <thead>
    <tr>
      <th>Name</th>
      <th>Source</th>
      <th>Default</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for config in configs %}
    <tr>
      <td>{{ config.name }}</td>
      <td><code>{{ config.source_model }}</code></td>
      <td>{% if config.is_default %}âœ”{% endif %}</td>
      <td>
        <form method="post" style="display:inline-block">
          {% csrf_token %}
          <input type="hidden" name="action" value="set_default">
          <input type="hidden" name="config_id" value="{{ config.id }}">
          <button type="submit" class="btn btn-sm btn-outline-primary">Set Default</button>
        </form>
        {% if configs|length > 1 %}
        <form method="post" style="display:inline-block">
          {% csrf_token %}
          <input type="hidden" name="action" value="delete">
          <input type="hidden" name="config_id" value="{{ config.id }}">
          <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?')">Delete</button>
        </form>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
    {% if not configs %}
    <tr><td colspan="4" class="text-muted">No saved settings yet.</td></tr>
    {% endif %}
  </tbody>
</table>
{% endblock %}
