{% load static %}
<div class="js-layout-block-root" id="layout-block-{{ instance_id }}" data-instance-id="{{ instance_id }}" data-block-name="{{ block_name }}">
{% if not embedded %}
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="d-flex align-items-center">
    <label class="me-2">Saved Pivots:</label>
    <select id="pivot-select-{{ block_name }}-{{ instance_id }}" class="form-select form-select-sm w-auto me-2">
      <option value="">-- Select --</option>
      {% regroup pivot_configs by visibility as pv_groups %}
      {% for grp in pv_groups %}
        <optgroup label="{{ grp.grouper|title }}">
          {% for c in grp.list %}
            <option value="{{ c.id }}" {% if c.id == active_pivot_config_id %}selected{% endif %}>{{ c.name }}{% if c.is_default %} (default){% endif %}</option>
          {% endfor %}
        </optgroup>
      {% endfor %}
    </select>
    <a class="btn btn-link p-0" href="{% url 'pivot_config_view' block_name %}">Manage Settings</a>
    <a class="btn btn-link p-0 ms-2" href="{% url 'render_pivot_block' block_name %}">Pivot Link</a>
  </div>
  <div class="d-flex align-items-center">
    <label class="me-2">Saved Filters:</label>
    <select id="filter-select-{{ block_name }}-{{ instance_id }}" class="form-select form-select-sm w-auto me-2">
      <option value="">-- Select --</option>
      {% regroup filter_configs by visibility as filt_groups %}
      {% for grp in filt_groups %}
        <optgroup label="{{ grp.grouper|title }}">
          {% for f in grp.list %}
            <option value="{{ f.id }}" {% if f.id == active_filter_config_id %}selected{% endif %}>{{ f.name }}{% if f.is_default %} (default){% endif %}</option>
          {% endfor %}
        </optgroup>
      {% endfor %}
    </select>
    <a class="btn btn-link p-0 ms-2" href="{% url 'pivot_filter_config' block_name %}">Manage Filters</a>
    {# moved Manage Filter Layout links into accordion #}
    <button id="download-xlsx-{{ block_name }}-{{ instance_id }}" class="btn btn-outline-secondary btn-sm ms-3" type="button">Download Excel</button>
    <button id="download-pdf-{{ block_name }}-{{ instance_id }}" class="btn btn-outline-secondary btn-sm ms-2" type="button">Download PDF</button>
  </div>
  
</div>

<form method="get" id="dynamic-filters-form-{{ block_name }}-{{ instance_id }}" class="mb-3">
  {% if active_pivot_config_id %}
    <input type="hidden" name="{{ block_name }}__{{ instance_id }}__pivot_config_id" value="{{ active_pivot_config_id }}">
  {% endif %}
  {% if active_filter_config_id %}
    <input type="hidden" name="{{ block_name }}__{{ instance_id }}__filter_config_id" value="{{ active_filter_config_id }}">
  {% endif %}
  <details class="border rounded">
    <summary class="p-2 bg-light" style="cursor:pointer;font-weight:bold">Filter Conditions</summary>
    <div class="p-3">
      <div class="mb-2">
        <a class="btn btn-link p-0" href="{% url 'filter_layout_view' block_name %}">Manage Filter Layout</a>
        {% if request.user.is_staff %}
          <a class="btn btn-link p-0 ms-3" href="{% url 'admin_filter_layout_view' block_name %}">Manage Default Filter Layout</a>
        {% endif %}
      </div>
      {% include "components/filter_fields.html" with filter_schema=filter_schema initial_values=selected_filter_values filter_layout=filter_layout name_prefix=block_name|add:"__"|add:instance_id|add:"__filters." id_prefix=block_name|add:"-"|add:instance_id require_layout=True %}
      <button type="submit" class="btn btn-primary mt-2">Apply Filters</button>
    </div>
  </details>
</form>

{# Layout-embedded title/notes just below Filter Conditions #}
{% if request.GET.embedded_title or request.GET.embedded_note or request.GET.embedded_edit %}
  <div class="mb-2">
    {% if request.GET.embedded_edit %}
      <div class="row g-2">
        <div class="col-12 col-md-6">
          <label class="form-label mb-1 small">Title (optional)</label>
          <input type="text" class="form-control form-control-sm js-block-title" data-id="{{ instance_id }}" value="{{ request.GET.embedded_title }}" placeholder="Enter a title for this block">
        </div>
        <div class="col-12">
          <label class="form-label mb-1 small">Notes (optional)</label>
          <textarea class="form-control form-control-sm js-block-notes" data-id="{{ instance_id }}" rows="2" placeholder="Enter notes for this block">{{ request.GET.embedded_note }}</textarea>
        </div>
      </div>
    {% else %}
      {% if request.GET.embedded_title %}<div class="fw-bold">{{ request.GET.embedded_title }}</div>{% endif %}
      {% if request.GET.embedded_note %}<div class="text-muted small">{{ request.GET.embedded_note|linebreaksbr }}</div>{% endif %}
    {% endif %}
  </div>
{% endif %}

<div id="table-{{ block_name }}-{{ instance_id }}"></div>

<script>
(function init(){
  if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', init, { once: true }); return; }
  {% if request.GET.embedded %}const IS_EMBEDDED = true;{% else %}const IS_EMBEDDED = false;{% endif %}
  const el = document.getElementById("table-{{ block_name }}-{{ instance_id }}");
  const table = new Tabulator(el, { data: {{ data|safe }}, columns: {{ columns|safe }}, ...{{ tabulator_options|safe }} });
  try { if (window.jspdf && window.jspdf.jsPDF && !window.jsPDF) { window.jsPDF = window.jspdf.jsPDF; } } catch(e) {}
  document.getElementById("download-xlsx-{{ block_name }}-{{ instance_id }}")?.addEventListener("click", function(){ try { const cfg = {{ xlsx_download|default:"{}"|safe }} || {}; const fn = (cfg.filename||"{{ block_name }}.xlsx"); table.download("xlsx", fn); } catch(e){ alert("Download failed"); } });
  document.getElementById("download-pdf-{{ block_name }}-{{ instance_id }}")?.addEventListener("click", function(){ try { const cfg={{ pdf_download|default:"{}"|safe }}||{}; const fn=(cfg.filename||"{{ block_name }}.pdf"); table.download("pdf", fn, { orientation: (cfg.orientation||"portrait") }); } catch(e){ alert("Download failed"); } });

  // Saved Pivots / Filters selectors update URL params with instance namespace
  const ns = "{{ block_name }}__{{ instance_id }}__";
  const clearNamespacedFilters = (url) => {
    const nsPrefix = ns + 'filters.';
    const toDelete = [];
    for (const [k] of url.searchParams.entries()){
      if (k.startsWith(nsPrefix)) toDelete.push(k);
    }
    toDelete.forEach(k => url.searchParams.delete(k));
  };
  const updateParam = (key, value, {clearNsFilters=false}={}) => {
    const url = new URL(window.location);
    if (clearNsFilters) clearNamespacedFilters(url);
    if (value) {
      url.searchParams.set(ns + key, value);
    } else {
      url.searchParams.delete(ns + key);
    }
    if (IS_EMBEDDED && typeof window.updateLayoutBlock === 'function') {
      history.replaceState(null, '', url.toString());
      window.updateLayoutBlock("{{ instance_id }}");
    } else {
      window.location = url.toString();
    }
  };
  document.getElementById("pivot-select-{{ block_name }}-{{ instance_id }}")?.addEventListener("change", (e) => {
    // Clear ad-hoc overrides given pivot schema may affect filters
    updateParam("pivot_config_id", e.target.value, {clearNsFilters:true});
  });
  document.getElementById("filter-select-{{ block_name }}-{{ instance_id }}")?.addEventListener("change", (e) => {
    // Clear ad-hoc overrides so saved filter applies cleanly
    updateParam("filter_config_id", e.target.value, {clearNsFilters:true});
  });

  // Intercept live filter form submit to AJAX refresh when embedded
  const form = document.getElementById('dynamic-filters-form-{{ block_name }}-{{ instance_id }}');
  form?.addEventListener('submit', function(e){
    if (!IS_EMBEDDED || typeof window.updateLayoutBlock !== 'function') return;
    e.preventDefault();
    const url = new URL(window.location.href);
    clearNamespacedFilters(url);
    const fd = new FormData(form);
    for (const [k, v] of fd.entries()){
      if (!k) continue;
      if (v === null || v === undefined) continue;
      if (String(v).length === 0) continue;
      url.searchParams.set(k, String(v));
    }
    history.replaceState(null, '', url.toString());
    window.updateLayoutBlock("{{ instance_id }}");
  });
})();
</script>

</div>
