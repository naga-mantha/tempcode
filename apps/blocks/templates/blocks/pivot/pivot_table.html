{% load static %}
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="d-flex align-items-center">
    <label class="me-2">Saved Pivots:</label>
    <select id="pivot-select-{{ block_name }}-{{ instance_id }}" class="form-select form-select-sm w-auto me-2">
      <option value="">-- Select --</option>
      {% for c in pivot_configs %}
        <option value="{{ c.id }}" {% if c.id == active_pivot_config_id %}selected{% endif %}>{{ c.name }}{% if c.is_default %} (default){% endif %}</option>
      {% endfor %}
    </select>
    <a class="btn btn-link p-0" href="{% url 'pivot_config_view' block_name %}">Manage Settings</a>
    <a class="btn btn-link p-0 ms-2" href="{% url 'render_pivot_block' block_name %}">Pivot Link</a>
  </div>
  <div class="d-flex align-items-center">
    <label class="me-2">Saved Filters:</label>
    <select id="filter-select-{{ block_name }}-{{ instance_id }}" class="form-select form-select-sm w-auto me-2">
      <option value="">-- Select --</option>
      {% for f in filter_configs %}
        <option value="{{ f.id }}" {% if f.id == active_filter_config_id %}selected{% endif %}>{{ f.name }}{% if f.is_default %} (default){% endif %}</option>
      {% endfor %}
    </select>
    <a class="btn btn-link p-0 ms-2" href="{% url 'pivot_filter_config' block_name %}">Manage Filters</a>
    <button id="download-xlsx-{{ block_name }}-{{ instance_id }}" class="btn btn-outline-secondary btn-sm ms-3" type="button">Download Excel</button>
    <button id="download-pdf-{{ block_name }}-{{ instance_id }}" class="btn btn-outline-secondary btn-sm ms-2" type="button">Download PDF</button>
  </div>
  
</div>

<form method="get" id="dynamic-filters-form-{{ block_name }}-{{ instance_id }}" class="mb-3">
  {% if active_pivot_config_id %}
    <input type="hidden" name="{{ block_name }}__{{ instance_id }}__pivot_config_id" value="{{ active_pivot_config_id }}">
  {% endif %}
  {% if active_filter_config_id %}
    <input type="hidden" name="{{ block_name }}__{{ instance_id }}__filter_config_id" value="{{ active_filter_config_id }}">
  {% endif %}
  <details class="border rounded">
    <summary class="p-2 bg-light" style="cursor:pointer;font-weight:bold">Filter Conditions</summary>
    <div class="p-3">
      {% include "components/filter_fields.html" with filter_schema=filter_schema initial_values=selected_filter_values name_prefix=block_name|add:"__"|add:instance_id|add:"__filters." id_prefix=block_name|add:"-"|add:instance_id %}
      <button type="submit" class="btn btn-primary mt-2">Apply Filters</button>
    </div>
  </details>
</form>

<div id="table-{{ block_name }}-{{ instance_id }}"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const el = document.getElementById("table-{{ block_name }}-{{ instance_id }}");
  const table = new Tabulator(el, { data: {{ data|safe }}, columns: {{ columns|safe }}, ...{{ tabulator_options|safe }} });
  try { if (window.jspdf && window.jspdf.jsPDF && !window.jsPDF) { window.jsPDF = window.jspdf.jsPDF; } } catch(e) {}
  document.getElementById("download-xlsx-{{ block_name }}-{{ instance_id }}")?.addEventListener("click", function(){ try { const cfg = {{ xlsx_download|default:"{}"|safe }} || {}; const fn = (cfg.filename||"{{ block_name }}.xlsx"); table.download("xlsx", fn); } catch(e){ alert("Download failed"); } });
  document.getElementById("download-pdf-{{ block_name }}-{{ instance_id }}")?.addEventListener("click", function(){ try { const cfg={{ pdf_download|default:"{}"|safe }}||{}; const fn=(cfg.filename||"{{ block_name }}.pdf"); table.download("pdf", fn, { orientation: (cfg.orientation||"portrait") }); } catch(e){ alert("Download failed"); } });

  // Saved Pivots / Filters selectors update URL params with instance namespace
  const ns = "{{ block_name }}__{{ instance_id }}__";
  const clearNamespacedFilters = (url) => {
    const nsPrefix = ns + 'filters.';
    const toDelete = [];
    for (const [k] of url.searchParams.entries()){
      if (k.startsWith(nsPrefix)) toDelete.push(k);
    }
    toDelete.forEach(k => url.searchParams.delete(k));
  };
  const updateParam = (key, value, {clearNsFilters=false}={}) => {
    const url = new URL(window.location);
    if (clearNsFilters) clearNamespacedFilters(url);
    if (value) {
      url.searchParams.set(ns + key, value);
    } else {
      url.searchParams.delete(ns + key);
    }
    window.location = url.toString();
  };
  document.getElementById("pivot-select-{{ block_name }}-{{ instance_id }}")?.addEventListener("change", (e) => {
    // Clear ad-hoc overrides given pivot schema may affect filters
    updateParam("pivot_config_id", e.target.value, {clearNsFilters:true});
  });
  document.getElementById("filter-select-{{ block_name }}-{{ instance_id }}")?.addEventListener("change", (e) => {
    // Clear ad-hoc overrides so saved filter applies cleanly
    updateParam("filter_config_id", e.target.value, {clearNsFilters:true});
  });
});
</script>
