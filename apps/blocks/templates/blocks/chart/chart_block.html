{% load static %}
<div class="js-layout-block-root" id="layout-block-{{ instance_id }}" data-instance-id="{{ instance_id }}" data-block-name="{{ block_name }}">
{% if not embedded %}
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <a class="btn btn-link p-0" href="{% url 'render_chart_block' block_name %}">Chart Link</a>
  </div>
  <div>
    <label class="me-2">Filter:</label>
    <select id="filter-config-select-{{ block_name }}-{{ instance_id }}" class="form-select d-inline-block w-auto">
      <option value="">-- None --</option>
      {% regroup filter_configs by visibility as filt_groups %}
      {% for grp in filt_groups %}
        <optgroup label="{{ grp.grouper|title }}">
          {% for f in grp.list %}
            <option value="{{ f.id }}" {% if f.id == active_filter_config_id %}selected{% endif %}>{{ f.name }}{% if f.is_default %} (default){% endif %}</option>
          {% endfor %}
        </optgroup>
      {% endfor %}
    </select>
    <a class="btn btn-link p-0 ms-2" href="{% url 'chart_filter_config' block_name %}">Manage Filters</a>
  </div>
</div>

<form method="get" id="dynamic-filters-form-{{ block_name }}-{{ instance_id }}" class="mb-3">
  {% if active_filter_config_id %}
    <input type="hidden" name="{{ block_name }}__{{ instance_id }}__filter_config_id" value="{{ active_filter_config_id }}">
  {% endif %}

  <details class="border rounded">
    <summary class="p-2 bg-light" style="cursor:pointer;font-weight:bold">
      Filter Conditions
    </summary>
    <div class="p-3">
      <div class="mb-2">
        <a class="btn btn-link p-0" href="{% url 'filter_layout_view' block_name %}">Manage Filter Layout</a>
        {% if request.user.is_staff %}
          <a class="btn btn-link p-0 ms-3" href="{% url 'admin_filter_layout_view' block_name %}">Manage Default Filter Layout</a>
        {% endif %}
      </div>
      {% include "components/filter_fields.html" with filter_schema=filter_schema initial_values=selected_filter_values filter_layout=filter_layout name_prefix=block_name|add:"__"|add:instance_id|add:"__filters." id_prefix=block_name|add:"-"|add:instance_id require_layout=True %}
      <button type="submit" class="btn btn-primary mt-2">Apply Filters</button>
    </div>
  </details>
</form>

{# Layout-embedded title/notes just below Filter Conditions #}
{% if request.GET.embedded_title or request.GET.embedded_note or request.GET.embedded_edit %}
  <div class="mb-2">
    {% if request.GET.embedded_edit %}
      <div class="row g-2">
        <div class="col-12 col-md-6">
          <label class="form-label mb-1 small">Title (optional)</label>
          <input type="text" class="form-control form-control-sm js-block-title" data-id="{{ instance_id }}" value="{{ request.GET.embedded_title }}" placeholder="Enter a title for this block">
        </div>
        <div class="col-12">
          <label class="form-label mb-1 small">Notes (optional)</label>
          <textarea class="form-control form-control-sm js-block-notes" data-id="{{ instance_id }}" rows="2" placeholder="Enter notes for this block">{{ request.GET.embedded_note }}</textarea>
        </div>
      </div>
    {% else %}
      {% if request.GET.embedded_title %}<div class="fw-bold">{{ request.GET.embedded_title }}</div>{% endif %}
      {% if request.GET.embedded_note %}<div class="text-muted small">{{ request.GET.embedded_note|linebreaksbr }}</div>{% endif %}
    {% endif %}
  </div>
{% endif %}

<div id="chart-{{ block_name }}-{{ instance_id }}" style="width:100%;height:100%;min-height:260px;"></div>

{% block scripts %}
<script>
  (function init(){
    if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', init, { once: true }); return; }
    {% if request.GET.embedded %}const IS_EMBEDDED = true;{% else %}const IS_EMBEDDED = false;{% endif %}
    const fig = {{ figure|safe }};
    const chartEl = document.getElementById('chart-{{ block_name }}-{{ instance_id }}');
    try {
      // Avoid Plotly's responsive auto-resize to prevent errors on hidden/off-DOM elements
      Plotly.newPlot(chartEl, fig.data, fig.layout);
    } catch (e) {}
    const safeResize = () => {
      try {
        if (!chartEl || !chartEl.isConnected) return;
        const style = window.getComputedStyle(chartEl);
        const hidden = (style.display === 'none') || (chartEl.offsetParent === null);
        if (hidden) return;
        if (chartEl.clientWidth <= 0 || chartEl.clientHeight <= 0) return;
        Plotly.Plots.resize(chartEl);
      } catch(_) {}
    };
    try {
      const ro = new ResizeObserver(() => safeResize());
      ro.observe(chartEl);
    } catch(e) {
      window.addEventListener('resize', safeResize);
    }

    const filtSelect = document.getElementById('filter-config-select-{{ block_name }}-{{ instance_id }}');
    function clearNamespacedFilters(urlObj){
      const nsPrefix = "{{ block_name }}__{{ instance_id }}__filters.";
      const toDelete = [];
      for (const [k] of urlObj.searchParams.entries()){
        if (k.startsWith(nsPrefix)) toDelete.push(k);
      }
      toDelete.forEach(k => urlObj.searchParams.delete(k));
    }
    filtSelect?.addEventListener('change', function() {
      const url = new URL(window.location.href);
      // Remove ad-hoc overrides so saved filter values apply
      clearNamespacedFilters(url);
      const key = '{{ block_name }}__{{ instance_id }}__filter_config_id';
      if (this.value) url.searchParams.set(key, this.value); else url.searchParams.delete(key);
      if (IS_EMBEDDED && typeof window.updateLayoutBlock === 'function') {
        history.replaceState(null, '', url.toString());
        window.updateLayoutBlock("{{ instance_id }}");
      } else {
        window.location.href = url.toString();
      }
    });

    // Intercept live filter form submit for partial refresh when embedded
    const form = document.getElementById('dynamic-filters-form-{{ block_name }}-{{ instance_id }}');
    form?.addEventListener('submit', function(e){
      if (!IS_EMBEDDED || typeof window.updateLayoutBlock !== 'function') return;
      e.preventDefault();
      const url = new URL(window.location.href);
      clearNamespacedFilters(url);
      const fd = new FormData(form);
      for (const [k, v] of fd.entries()){
        if (!k) continue;
        if (v === null || v === undefined) continue;
        if (String(v).length === 0) continue;
        url.searchParams.set(k, String(v));
      }
      history.replaceState(null, '', url.toString());
      window.updateLayoutBlock("{{ instance_id }}");
    });
  })();
</script>
{% endblock %}

</div>
