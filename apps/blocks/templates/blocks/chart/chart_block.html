{% load static %}
{% if not embedded %}
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <a class="btn btn-link p-0" href="{% url 'render_chart_block' block_name %}">Chart Link</a>
  </div>
  <div>
    <label class="me-2">Filter:</label>
    <select id="filter-config-select-{{ block_name }}-{{ instance_id }}" class="form-select d-inline-block w-auto">
      <option value="">-- None --</option>
      {% for f in filter_configs %}
        <option value="{{ f.id }}" {% if f.id == active_filter_config_id %}selected{% endif %}>
          {{ f.name }}{% if f.is_default %} (default){% endif %}
        </option>
      {% endfor %}
    </select>
    <a class="btn btn-link p-0 ms-2" href="{% url 'chart_filter_config' block_name %}">Manage Filters</a>
  </div>
</div>

<form method="get" id="dynamic-filters-form-{{ block_name }}-{{ instance_id }}" class="mb-3">
  {% if active_filter_config_id %}
    <input type="hidden" name="{{ block_name }}__{{ instance_id }}__filter_config_id" value="{{ active_filter_config_id }}">
  {% endif %}

  <details class="border rounded">
    <summary class="p-2 bg-light" style="cursor:pointer;font-weight:bold">
      Filter Conditions
    </summary>
    <div class="p-3">
      <div class="mb-2">
        <a class="btn btn-link p-0" href="{% url 'filter_layout_view' block_name %}">Manage Filter Layout</a>
        {% if request.user.is_staff %}
          <a class="btn btn-link p-0 ms-3" href="{% url 'admin_filter_layout_view' block_name %}">Manage Default Filter Layout</a>
        {% endif %}
      </div>
      {% include "components/filter_fields.html" with filter_schema=filter_schema initial_values=selected_filter_values filter_layout=filter_layout name_prefix=block_name|add:"__"|add:instance_id|add:"__filters." id_prefix=block_name|add:"-"|add:instance_id %}
      <button type="submit" class="btn btn-primary mt-2">Apply Filters</button>
    </div>
  </details>
</form>

<div id="chart-{{ block_name }}-{{ instance_id }}" style="width:100%;height:100%;min-height:260px;"></div>

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const fig = {{ figure|safe }};
    const chartEl = document.getElementById('chart-{{ block_name }}-{{ instance_id }}');
    try {
      Plotly.newPlot(chartEl, fig.data, fig.layout, {responsive: true});
    } catch (e) {
      try { Plotly.newPlot(chartEl, fig.data, fig.layout); } catch(e2) {}
    }
    try {
      const ro = new ResizeObserver(() => { try { Plotly.Plots.resize(chartEl); } catch(e){} });
      ro.observe(chartEl);
    } catch(e) {
      window.addEventListener('resize', () => { try { Plotly.Plots.resize(chartEl); } catch(_){} });
    }

    const filtSelect = document.getElementById('filter-config-select-{{ block_name }}-{{ instance_id }}');
    function clearNamespacedFilters(urlObj){
      const nsPrefix = "{{ block_name }}__{{ instance_id }}__filters.";
      const toDelete = [];
      for (const [k] of urlObj.searchParams.entries()){
        if (k.startsWith(nsPrefix)) toDelete.push(k);
      }
      toDelete.forEach(k => urlObj.searchParams.delete(k));
    }
    filtSelect?.addEventListener('change', function() {
      const url = new URL(window.location.href);
      // Remove ad-hoc overrides so saved filter values apply
      clearNamespacedFilters(url);
      const key = '{{ block_name }}__{{ instance_id }}__filter_config_id';
      if (this.value) url.searchParams.set(key, this.value); else url.searchParams.delete(key);
      window.location.href = url.toString();
    });
  });
</script>
{% endblock %}

