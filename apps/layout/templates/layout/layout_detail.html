{% extends "base.html" %}

{% load dict_extras %}
{% block content %}
  <div class="main-container-fluid">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h1 class="mb-0">{{ layout.name }}</h1>
      <div class="d-flex align-items-center gap-2">
        {% if can_edit %}
          <a href="{% url 'layout_edit' username=layout.user.username slug=layout.slug %}" class="btn btn-success btn-sm">Edit</a>
        {% endif %}
        {% if can_delete %}
          <a href="{% url 'layout_delete' username=layout.user.username slug=layout.slug %}" class="btn btn-danger btn-sm">Delete</a>
        {% endif %}
      </div>
    </div>

    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="me-3">
        <details class="border rounded">
          <summary class="p-2 bg-light" style="cursor:pointer;font-weight:bold">Filter Conditions</summary>
          <div class="p-3">
            <form method="get" id="layout-filters-form">
              {% if active_filter_config_id %}
                <input type="hidden" name="filter_config_id" value="{{ active_filter_config_id }}">
              {% endif %}
              {% include "components/filter_fields.html" with filter_schema=filter_schema initial_values=selected_filter_values id_prefix="layout" %}
              <button type="submit" class="btn btn-primary mt-2">Apply Filters</button>
            </form>
          </div>
        </details>
      </div>
      <div class="d-flex align-items-center">
        <label class="me-2">Layout Filter:</label>
        <select id="layout-filter-select" class="form-select d-inline-block w-auto">
          <option value="">-- None --</option>
          {% for f in filter_configs %}
            <option value="{{ f.id }}" {% if f.id == active_filter_config_id %}selected{% endif %}>
              {{ f.name }}{% if f.is_default %} (default){% endif %}
            </option>
          {% endfor %}
        </select>
        <a class="btn btn-link p-0 ms-2" href="{% url 'layout_filter_config' username=layout.user.username slug=layout.slug %}">Manage Filters</a>
        <a class="btn btn-link p-0 ms-2" href="{% url 'layout_detail' username=layout.user.username slug=layout.slug %}">Reset</a>
      </div>
    </div>

    {% if layout.description %}
      <div class="alert alert-info">{{ layout.description|linebreaksbr }}</div>
    {% endif %}

    <h2 class="mt-4">Blocks</h2>
    <hr>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@10.1.2/dist/gridstack.min.css">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <div class="grid-stack" id="grid-view" data-gs-static="true">
      {% for b in blocks %}
        <div class="grid-stack-item" gs-x="{{ b.x|default:0 }}" gs-y="{{ b.y|default:0 }}" gs-w="{{ b.w|default:4 }}" gs-h="{{ b.h|default:2 }}">
          <div class="grid-stack-item-content card p-2">
            {{ b.html|safe }}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  

  <style>
  /* Ensure grid can expand to full width */
  #grid-view { width: 100%; max-width: 100%; }
  /* Gridstack content should stretch to occupy tile */
  .grid-stack .grid-stack-item-content { display: flex; flex-direction: column; min-height: 100%; }
  /* When block output is wrapped, keep wrapper stretching */
  .grid-stack .grid-stack-item-content > .js-layout-block-root { display: flex; flex-direction: column; min-height: 100%; position: relative; }
  .grid-stack .grid-stack-item-content > div[id^="chart-"] { flex: 1 1 auto; }
  .grid-stack .grid-stack-item-content .js-layout-block-root > div[id^="chart-"] { flex: 1 1 auto; }
  .grid-stack .grid-stack-item-content .js-layout-block-root > div[id^="table-"] { flex: 1 1 auto; }
  /* Ensure Bootstrap columns inside tiles don't constrain width */
  .grid-stack .grid-stack-item-content [class^="col-"],
  .grid-stack .grid-stack-item-content [class*=" col-"] { width: auto !important; max-width: none !important; }
  /* Loading overlay for AJAX block refresh */
  .block-loading-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.6); z-index: 10; }
  /* Sidebar list styles: darker text; lighter active background */
  .offcanvas .list-group-item { color: #212529; }
  .offcanvas .list-group-item.active {
    background-color: #f1f3f5;
    color: #212529;
    border-color: #e9ecef;
  }
  </style>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function(){
    // Persist offcanvas open/close state in localStorage
    try {
      const el = document.getElementById('layoutSidebar');
      if (window.bootstrap && el) {
        const KEY = 'layoutSidebarOpen';
        el.addEventListener('shown.bs.offcanvas', () => { try { localStorage.setItem(KEY, '1'); } catch(_) {} });
        el.addEventListener('hidden.bs.offcanvas', () => { try { localStorage.setItem(KEY, '0'); } catch(_) {} });
        const wasOpen = (localStorage.getItem(KEY) === '1');
        if (wasOpen) {
          const oc = bootstrap.Offcanvas.getOrCreateInstance(el);
          oc.show();
        }
      }
    } catch(_) {}

    // Layout filter dropdown behavior (kept from previous UI)
    const sel = document.getElementById('layout-filter-select');
    sel?.addEventListener('change', function(){
      const url = new URL(window.location.href);
      const v = this.value || '';
      const toDelete = [];
      url.searchParams.forEach((val, key) => { if (key.startsWith('filters.')) toDelete.push(key); });
      toDelete.forEach(k => url.searchParams.delete(k));
      if (v) url.searchParams.set('filter_config_id', v); else url.searchParams.delete('filter_config_id');
      window.location.href = url.toString();
    });

    // Initialize Gridstack view-only grid
    const container = document.getElementById('grid-view');
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/gridstack@10.1.2/dist/gridstack-all.min.js';
    s.onload = function(){
      const grid = GridStack.init({ float: false, staticGrid: true, cellHeight: 136, margin: 8 }, container);
    };
    document.body.appendChild(s);

    // Expose a helper to refresh a single block without full reload
    window.updateLayoutBlock = function(instanceId){
      try {
        const targetId = 'layout-block-' + String(instanceId);
        const current = document.getElementById(targetId);
        if (!current) return;
        // Show a loading overlay while fetching updated HTML
        let overlay = current.querySelector(':scope > .block-loading-overlay');
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.className = 'block-loading-overlay';
          overlay.innerHTML = '<div class="spinner-border text-secondary" role="status" aria-label="Loading"></div>';
          current.appendChild(overlay);
        }
        const renderUrl = new URL(window.location.pathname.replace(/\/$/, '') + '/block/' + String(instanceId) + '/render/', window.location.origin);
        // Pass through current query params so server can resolve selections
        renderUrl.search = window.location.search;
        fetch(renderUrl.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
          .then(res => res.json())
          .then(data => {
            if (!data || typeof data.html !== 'string') return;
            // Replace the block root and re-execute any scripts in the fragment
            const wrapper = document.createElement('div');
            wrapper.innerHTML = data.html;
            const next = wrapper.querySelector('#' + CSS.escape(targetId)) || wrapper.firstElementChild;
            if (!next) return;
            current.replaceWith(next);
            // Execute scripts within the inserted block
            const scripts = next.querySelectorAll('script');
            scripts.forEach(old => {
              const s = document.createElement('script');
              // Copy attributes (e.g., type, src)
              for (const attr of old.attributes) { s.setAttribute(attr.name, attr.value); }
              s.text = old.text || old.textContent || '';
              old.replaceWith(s);
            });
          })
          .catch(() => {
            // Remove overlay on error
            try { overlay?.remove(); } catch(_) {}
          });
      } catch(_) {}
    };

    // Intercept layout filters form submit to preserve per-block selections
    try {
      const lf = document.getElementById('layout-filters-form');
      lf?.addEventListener('submit', function(ev){
        ev.preventDefault();
        const url = new URL(window.location.href);
        // Remove only top-level layout filters (filters.*) and then add current form inputs
        const toDelete = [];
        url.searchParams.forEach((val, key) => { if (key.startsWith('filters.')) toDelete.push(key); });
        toDelete.forEach(k => url.searchParams.delete(k));
        const fd = new FormData(lf);
        for (const [k, v] of fd.entries()){
          if (!k) continue;
          // Forward filter_config_id and filters.* from the form
          url.searchParams.set(k, String(v ?? ''));
        }
        // Navigate without losing per-block selections already in URL
        window.location.href = url.toString();
      });
    } catch(_) {}
  });
  </script>
{% endblock %}






