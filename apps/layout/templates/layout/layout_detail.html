{% extends "base.html" %}

{% load dict_extras %}
{% block content %}
  <div class="main-container-fluid">
    <h1>{{ layout.name }}</h1>
    <p>
    {% if can_edit %}
      <a href="{% url 'layout_edit' username=layout.user.username slug=layout.slug %}">Edit layout</a>
      |
    {% endif %}
      <a href="{% url 'layout_list' %}">All layouts</a>
      {% if can_delete %}
        |
        <a href="{% url 'layout_delete' username=layout.user.username slug=layout.slug %}">Delete</a>
      {% endif %}
    </p>

    <div class="d-flex justify-content-end align-items-center mb-3">
      <label class="me-2">Layout Filter:</label>
      <select id="layout-filter-select" class="form-select d-inline-block w-auto">
        <option value="">-- None --</option>
        {% for f in filter_configs %}
          <option value="{{ f.id }}" {% if f.id == active_filter_config_id %}selected{% endif %}>
            {{ f.name }}{% if f.is_default %} (default){% endif %}
          </option>
        {% endfor %}
      </select>
      <a class="btn btn-link p-0 ms-2" href="{% url 'layout_filter_config' username=layout.user.username slug=layout.slug %}">Manage Filters</a>
      <a class="btn btn-link p-0 ms-2" href="{% url 'layout_detail' username=layout.user.username slug=layout.slug %}">Reset</a>
    </div>

    {# Live (non-persistent) layout-level filter overrides #}
    <form method="get" class="mb-3">
      {% if active_filter_config_id %}
        <input type="hidden" name="filter_config_id" value="{{ active_filter_config_id }}">
      {% endif %}

      <details class="border rounded">
        <summary class="p-2 bg-light" style="cursor:pointer;font-weight:bold">
          Filter Conditions
        </summary>
        <div class="p-3">
          {% include "components/filter_fields.html" with filter_schema=filter_schema initial_values=selected_filter_values id_prefix="layout" %}
          <button type="submit" class="btn btn-primary mt-2">Apply Filters</button>
        </div>
      </details>
    </form>

    {% if layout.description %}
      <div class="alert alert-info">{{ layout.description|linebreaksbr }}</div>
    {% endif %}

     <h3 class="mt-5">Blocks</h3>
      <hr>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@10.1.2/dist/gridstack.min.css">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <div class="grid-stack" id="grid-view" data-gs-static="true" style="gap:16px 8px; --gs-gutter-rows:16px; --gs-gutter-cols:8px;">
      {% for b in blocks %}
        <div class="grid-stack-item" gs-x="{{ b.x|default:0 }}" gs-y="{{ b.y|default:0 }}" gs-w="{{ b.w|default:4 }}" gs-h="{{ b.h|default:2 }}">
          <div class="grid-stack-item-content card p-2">
            {% if b.title %}<div class="mb-2 fw-bold">{{ b.title }}</div>{% endif %}
            {% if b.note %}<div class="mb-2 text-muted small">{{ b.note|linebreaksbr }}</div>{% endif %}
            {{ b.html|safe }}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  <style>
  /* Force Grid layout + gaps (Gridstack v10 uses CSS Grid) */
  #grid-view.grid-stack { display: grid !important; row-gap: 16px !important; column-gap: 8px !important; }
  /* Gridstack content should stretch to occupy tile */
  .grid-stack .grid-stack-item-content { display: flex; flex-direction: column; min-height: 100%; }
  .grid-stack .grid-stack-item-content > div[id^="chart-"] { flex: 1 1 auto; }.grid-stack .grid-stack-item { margin-bottom: 16px !important; }
  /* Ensure Bootstrap columns inside tiles don't constrain width */
  .grid-stack .grid-stack-item-content [class^="col-"],
  .grid-stack .grid-stack-item-content [class*=" col-"] { width: auto !important; max-width: none !important; }#grid-view.grid-stack .grid-stack-item { margin-top: 16px !important; }
  #grid-view.grid-stack .grid-stack-item[gs-y="0"] { margin-top: 0 !important; }
  </style>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function(){
    const sel = document.getElementById('layout-filter-select');
    sel?.addEventListener('change', function(){
      const url = new URL(window.location.href);
      const v = this.value || '';
      const toDelete = [];
      url.searchParams.forEach((val, key) => { if (key.startsWith('filters.')) toDelete.push(key); });
      toDelete.forEach(k => url.searchParams.delete(k));
      if (v) url.searchParams.set('filter_config_id', v); else url.searchParams.delete('filter_config_id');
      window.location.href = url.toString();
    });

    const container = document.getElementById('grid-view');
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/gridstack@10.1.2/dist/gridstack-all.min.js';
    s.onload = function(){
      const CELL = 120; // must match cellHeight
      const GUTTER = 16; // vertical gutter between rows
      const grid = GridStack.init({ float:false, staticGrid:true, cellHeight:CELL, margin: 16 }, container);
      // Apply translate-based gutter
      try {
        container.querySelectorAll('.grid-stack-item').forEach(el => {
          const y = parseInt(el.getAttribute('gs-y') || '0', 10) || 0;
          el.style.transform = 'translateY(' + (y * GUTTER) + 'px)';
        });
        // Set container height based on rows
        const rows = parseInt(container.getAttribute('gs-current-row') || '0', 10) || 0;
        const h = (rows * CELL) + (Math.max(0, rows - 1) * GUTTER);
        container.style.height = h + 'px';
        container.style.position = 'relative';
      } catch(e) {}
    };
    document.body.appendChild(s);
  });
  </script>
<script>
  // Ensure container height accounts for translate gutter on resize
  document.addEventListener('DOMContentLoaded', function(){
    const container = document.getElementById('grid-view');
    if (!container) return;
    function adjust(){
      try {
        const CELL = 120, GUTTER = 16;
        const rows = parseInt(container.getAttribute('gs-current-row') || '0', 10) || 0;
        const h = (rows * CELL) + (Math.max(0, rows - 1) * GUTTER);
        container.style.height = h + 'px';
      } catch(e) {}
    }
    setTimeout(adjust, 0);
    window.addEventListener('resize', adjust);
  });
</script>
{% endblock %}




