{% extends "base.html" %}

{% block content %}
  <div class="main-container">
    <h1 class="page-title">Edit Layout: {{ layout.name }}</h1>
    <p>
      <a href="{% url 'layout_detail' username=layout.user.username slug=layout.slug %}">Back to layout</a>
    </p>

    <div class="card mb-5">
      <div class="card-body">
        <h5 class="card-title">Add Block</h5>
        <form method="post" id="add-block-form">
          {% csrf_token %}
          <div class="row g-2 align-items-end">
            <div class="col-md-8">
              <label class="form-label">Block</label>
              {{ add_form.block }}
            </div>
          </div>
        </form>
      </div>
     </div>

    <h2>Blocks</h2>

    <form method="post">
      {% csrf_token %}
      {{ formset.management_form }}
      <div id="layout-rows" class="row g-3">
        {% include 'layout/_layout_rows.html' %}
      </div>
      <!-- No Save button needed: changes auto-save -->
    </form>
  </div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('layout-rows');
    if (!container) return;
    const reorderUrl = "{% url 'layout_reorder' username=layout.user.username slug=layout.slug %}";
    const updateUrlBase = "{% url 'layout_edit' username=layout.user.username slug=layout.slug %}".replace(/\/edit\/$/, '') + "/block/"; // append id + /update|delete/
    const deleteUrlBase = updateUrlBase;
    const addUrl = "{% url 'layout_block_add' username=layout.user.username slug=layout.slug %}";

    // CSRF helper
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    function getCsrfToken() {
      return getCookie('csrftoken') || (document.querySelector('input[name="csrfmiddlewaretoken"]') || {}).value || '';
    }
    const csrftoken = getCsrfToken();

    // Simple toast for error/success messages
    function showToast(message, variant) {
      const id = 'js-toast-container';
      let c = document.getElementById(id);
      if (!c) {
        c = document.createElement('div');
        c.id = id;
        c.style.position = 'fixed';
        c.style.right = '16px';
        c.style.bottom = '16px';
        c.style.zIndex = '1080';
        c.style.display = 'flex';
        c.style.flexDirection = 'column';
        c.style.gap = '8px';
        document.body.appendChild(c);
      }
      const el = document.createElement('div');
      el.textContent = message || 'An error occurred';
      el.style.padding = '10px 14px';
      el.style.borderRadius = '4px';
      el.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
      el.style.color = '#fff';
      el.style.fontSize = '14px';
      el.style.opacity = '0';
      el.style.transition = 'opacity .2s ease';
      el.style.background = (variant === 'success') ? '#198754' : (variant === 'warning' ? '#fd7e14' : '#dc3545');
      c.appendChild(el);
      requestAnimationFrame(function(){ el.style.opacity = '1'; });
      setTimeout(function(){ el.style.opacity = '0'; setTimeout(function(){ el.remove(); }, 200); }, 3000);
    }

    // Hook delete buttons
    container.addEventListener('click', function(e){
      const btn = e.target.closest('.js-delete-row');
      if (!btn) return;
      e.preventDefault();
      if(!confirm('Delete this block from layout?')) return;
      const tr = btn.closest('.layout-item');
      const id = tr && parseInt(tr.getAttribute('data-id'), 10);
      if (!id) return;
      fetch(`${deleteUrlBase}${id}/delete/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken || ''
        }
      }).then(function(resp){
        if (resp.ok) {
          tr.remove();
        } else {
          showToast('Failed to delete block', 'error');
        }
      }).catch(function(){ showToast('Failed to delete block', 'error'); });
    });

    function initOrderFields() {
      const rows = container.querySelectorAll('.layout-item');
      rows.forEach(function(tr, idx){
        const orderInput = tr.querySelector('input[type="number"][name$="-ORDER"]');
        if (orderInput) orderInput.value = idx + 1;
      });
    }
    function initSortable() {
      if (!window.Sortable) return;
      Sortable.create(container, {
        handle: '.js-drag-handle',
        animation: 150,
        onSort: function(){
          const rows = container.querySelectorAll('.layout-item');
          rows.forEach(function(tr, idx){
            const orderInput = tr.querySelector('input[type="number"][name$="-ORDER"]');
            if (orderInput) orderInput.value = idx + 1;
          });
          const ids = Array.from(rows).map(function(tr){
            return parseInt(tr.getAttribute('data-id'), 10);
          }).filter(function(x){ return !isNaN(x); });
          if (ids.length) {
            fetch(reorderUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken || ''
              },
              body: JSON.stringify({ordered_ids: ids})
            }).then(function(resp){
              if (!resp.ok) showToast('Failed to save order', 'error');
            }).catch(function(){ showToast('Failed to save order', 'error'); });
          }
        }
      });
      initOrderFields();
    }
    initSortable();

    // Auto-save column width changes per row
    function collectRowPayload(tr) {
      const pick = function(name){
        const el = tr.querySelector(`[name$="-${name}"]`);
        if (!el) return undefined;
        const v = (el.value || '').trim();
        return v === '' ? null : parseInt(v, 10);
      };
      return {
        col_sm: pick('col_sm'),
        col_md: pick('col_md'),
        col_lg: pick('col_lg'),
        col_xl: pick('col_xl'),
        col_xxl: pick('col_xxl')
      };
    }
    // Listen to select changes for auto-save
    container.addEventListener('change', function(e){
      const control = e.target.closest('select');
      if (!control) return;
      const tr = control.closest('.layout-item');
      const id = tr && parseInt(tr.getAttribute('data-id'), 10);
      if (!id) return;
      const payload = collectRowPayload(tr);
      fetch(`${updateUrlBase}${id}/update/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken || ''
        },
        body: JSON.stringify(payload)
      }).then(function(resp){
        if (!resp.ok) showToast('Failed to save changes', 'error');
      }).catch(function(){ showToast('Failed to save changes', 'error'); });
    });

    // Remove dropdown-specific handlers

    // AJAX Add Block on select change
    (function(){
      const addForm = document.getElementById('add-block-form');
      if (!addForm) return;
      const sel = addForm.querySelector('select[name="block"]');
      if (!sel) return;
      sel.addEventListener('change', function(){
        const val = sel.value;
        if (!val) return;
        sel.disabled = true;
        fetch(addUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken || ''
          },
          body: JSON.stringify({block: val})
        }).then(function(resp){ return resp.json(); })
          .then(function(data){
            if (!data || !data.ok) { showToast('Failed to add block', 'error'); return; }
            if (data.tbody_html) {
              container.innerHTML = data.tbody_html;
              initSortable();
            }
          })
          .catch(function(){ showToast('Failed to add block', 'error'); })
          .finally(function(){ sel.disabled = false; sel.value = ''; });
      });
    })();
  });
</script>
<style>
  /* Card/grid layout spacing */
  .layout-item .js-drag-handle { cursor: grab; }
  .js-toast-container { z-index: 1080; }
  /* optional: size down selects */
  .layout-item select { padding: .25rem .5rem; font-size: .875rem; height: calc(1.5em + .5rem + 2px); }
</style>
{% endblock %}
