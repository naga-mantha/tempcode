{% extends "base.html" %}

{% block content %}
  <div class="main-container-fluid">
    <h1>Edit Layout: {{ layout.name }}</h1>
    <p>
      <a href="{% url 'layout_detail' username=layout.user.username slug=layout.slug %}">Back to layout</a>
      <span class="text-muted ms-2">Drag rows to reorder. Set column width per block.</span>
    </p>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Add Block</h5>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="add_block" value="1">
          <div class="row g-2 align-items-end">
            <div class="col-md-6">
              <label class="form-label">Block</label>
              {{ add_form.block }}
            </div>
            <div class="col-md-3">
              <label class="form-label">Col (1,2,3,4,6,12)</label>
              {{ add_form.col }}
            </div>
            <div class="col-md-3">
              <button type="submit" class="btn btn-primary">Add</button>
            </div>
          </div>
          {% if add_form.errors %}
            <div class="text-danger mt-2">{{ add_form.errors }}</div>
          {% endif %}
        </form>
      </div>
     </div>

    <form method="post">
      {% csrf_token %}
      {{ formset.management_form }}
      <table class="table" id="layout-edit-table">
        <thead>
            <tr>
              <th style="width: 40px;"></th>
              <th>Block</th>
              <th style="width: 160px;">Col (1,2,3,4,6,12)</th>
              <th style="width: 120px;">Actions</th>
            </tr>
          </thead>
          <tbody id="layout-rows">
            {% for form in formset %}
              <tr class="layout-row" data-index="{{ forloop.counter0 }}">
                <td class="text-muted align-middle" style="cursor:grab">â‰¡</td>
                <td class="align-middle">
                  {{ form.instance.block.name }}
                  {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                  {# ORDER field from can_order; keep hidden but present #}
                  <span style="display:none;">{{ form.ORDER }}</span>
                </td>
                <td>{{ form.col }}</td>
                <td>
                  <span style="display:none;">{{ form.DELETE }}</span>
                  <button type="button" class="btn btn-sm btn-outline-danger js-delete-row">Delete</button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        <button type="submit" class="btn btn-primary">Save</button>
      </form>
  </div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const tbody = document.getElementById('layout-rows');
    if (!tbody) return;

    // Hook delete buttons
    tbody.addEventListener('click', function(e){
      const btn = e.target.closest('.js-delete-row');
      if (!btn) return;
      e.preventDefault();
      if(!confirm('Delete this block from layout?')) return;
      const tr = btn.closest('tr');
      const del = tr && tr.querySelector('input[type=checkbox][name$="-DELETE"]');
      if (del) { del.checked = true; }
      btn.form && btn.form.submit();
    });

    // Initialize Sortable for drag/drop ordering
    if (window.Sortable) {
      const sortable = Sortable.create(tbody, {
        handle: 'td:first-child',
        animation: 150,
        onSort: function(){
          // Re-number ORDER fields 1..n based on current row order
          const rows = tbody.querySelectorAll('tr');
          rows.forEach(function(tr, idx){
            const orderInput = tr.querySelector('input[type="number"][name$="-ORDER"]');
            if (orderInput) orderInput.value = idx + 1; // Django expects 1-based order
          });
        }
      });
      // Initialize ORDER fields on load
      const rows = tbody.querySelectorAll('tr');
      rows.forEach(function(tr, idx){
        const orderInput = tr.querySelector('input[type="number"][name$="-ORDER"]');
        if (orderInput) orderInput.value = idx + 1;
      });
    }
  });
</script>
{% endblock %}
