{% extends "base.html" %}

{% load dict_extras %}
{% block content %}
  <div class="main-container-fluid">
    <h1 class="page-title">Edit Layout: {{ layout.name }}</h1>
    <p>
      <a href="{% url 'layout_detail' username=layout.user.username slug=layout.slug %}">Back to layout</a>
    </p>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Layout Details</h5>
        <form id="layout-details-form" method="post" action="{% url 'layout_rename' username=layout.user.username slug=layout.slug %}">
          {% csrf_token %}
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" name="name" value="{{ layout.name }}" required>
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" name="description" rows="3">{{ layout.description }}</textarea>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Add Block</h5>
        <form method="post" id="add-block-form">
          {% csrf_token %}
          <div class="row g-2 align-items-end">
            <div class="col-md-8">
              <label class="form-label">Block</label>
              {{ add_form.block }}
            </div>
          </div>
        </form>
      </div>
    </div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@10.1.2/dist/gridstack.min.css">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <div class="grid-stack" id="grid-edit" style="gap:16px 8px; --gs-gutter-rows:16px; --gs-gutter-cols:8px;">
      {% for b in blocks %}
        <div class="grid-stack-item" gs-x="{{ b.x|default:0 }}" gs-y="{{ b.y|default:0 }}" gs-w="{{ b.w|default:4 }}" gs-h="{{ b.h|default:2 }}" data-id="{{ b.id }}">
          <div class="grid-stack-item-content card p-2">
            <div class="d-flex justify-content-end">
              <button type="button" class="btn btn-sm btn-outline-danger js-del-widget" data-id="{{ b.id }}">Delete</button>
            </div>
            {{ b.html|safe }}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('grid-edit');
    const detailsForm = document.getElementById('layout-details-form');
    const gridSaveUrl = "{% url 'layout_grid_update' username=layout.user.username slug=layout.slug %}";
    const updateUrlBase = "{% url 'layout_edit' username=layout.user.username slug=layout.slug %}".replace(/\/edit\/$/, '') + "/block/"; // append id + /update|delete/
    const deleteUrlBase = updateUrlBase;
    const addUrl = "{% url 'layout_block_add' username=layout.user.username slug=layout.slug %}";

    // CSRF helper
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    function getCsrfToken() {
      return getCookie('csrftoken') || (document.querySelector('input[name="csrfmiddlewaretoken"]') || {}).value || '';
    }
    const csrftoken = getCsrfToken();

    // Simple toast for error/success messages
    function showToast(message, variant) {
      const id = 'js-toast-container';
      let c = document.getElementById(id);
      if (!c) {
        c = document.createElement('div');
        c.id = id;
        c.style.position = 'fixed';
        c.style.right = '16px';
        c.style.bottom = '16px';
        c.style.zIndex = '1080';
        c.style.display = 'flex';
        c.style.flexDirection = 'column';
        c.style.gap = '8px';
        document.body.appendChild(c);
      }
      const el = document.createElement('div');
      el.textContent = message || 'An error occurred';
      el.style.padding = '10px 14px';
      el.style.borderRadius = '4px';
      el.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
      el.style.color = '#fff';
      el.style.fontSize = '14px';
      el.style.opacity = '0';
      el.style.transition = 'opacity .2s ease';
      el.style.background = (variant === 'success') ? '#198754' : (variant === 'warning' ? '#fd7e14' : '#dc3545');
      c.appendChild(el);
      requestAnimationFrame(function(){ el.style.opacity = '1'; });
      setTimeout(function(){ el.style.opacity = '0'; setTimeout(function(){ el.remove(); }, 200); }, 3000);
    }

    // Auto-save layout name/description via AJAX with debounce
    (function(){
      if (!detailsForm) return;
      const nameEl = detailsForm.querySelector('input[name="name"]');
      const descEl = detailsForm.querySelector('textarea[name="description"]');
      let timer = null;
      function scheduleSave(){
        if (timer) clearTimeout(timer);
        timer = setTimeout(doSave, 400);
      }
      function doSave(){
        const payload = {
          name: (nameEl && nameEl.value || '').trim(),
          description: (descEl && descEl.value || '').trim()
        };
        fetch(detailsForm.action, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRFToken': csrftoken || ''
          },
          body: JSON.stringify(payload)
        }).then(function(resp){ return resp.json().catch(function(){ return { ok:false }; }); })
          .then(function(data){
            if (!data || !data.ok) { showToast('Failed to save layout details', 'error'); return; }
            // If slug changed, reload to the new Edit URL to refresh dependent URLs
            const currentPath = window.location.pathname;
            if (data.edit_url && currentPath !== data.edit_url) {
              window.location.href = data.edit_url;
              return;
            }
            // Update page title
            const h1 = document.querySelector('h1.page-title');
            if (h1 && data.name) h1.textContent = 'Edit Layout: ' + data.name;
            // Update back link if provided
            const backLink = document.querySelector('a[href*="{% url 'layout_detail' username=layout.user.username slug=layout.slug %}"]');
            if (backLink && data.detail_url) backLink.setAttribute('href', data.detail_url);
            showToast('Saved', 'success');
          })
          .catch(function(){ showToast('Failed to save layout details', 'error'); });
      }
      if (nameEl) nameEl.addEventListener('input', scheduleSave);
      if (descEl) descEl.addEventListener('input', scheduleSave);
    })();

    // Hook delete buttons
    container.addEventListener('click', function(e){
      const btn = e.target.closest('.js-delete-row');
      if (!btn) return;
      e.preventDefault();
      if(!confirm('Delete this block from layout?')) return;
      const tr = btn.closest('.layout-item');
      const id = tr && parseInt(tr.getAttribute('data-id'), 10);
      if (!id) return;
      fetch(`${deleteUrlBase}${id}/delete/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken || ''
        }
      }).then(function(resp){
        if (resp.ok) {
          tr.remove();
        } else {
          showToast('Failed to delete block', 'error');
        }
      }).catch(function(){ showToast('Failed to delete block', 'error'); });
    });

    function initOrderFields() {
      const rows = container.querySelectorAll('.layout-item');
      rows.forEach(function(tr, idx){
        const orderInput = tr.querySelector('input[type="number"][name$="-ORDER"]');
        if (orderInput) orderInput.value = idx + 1;
      });
    }
    // Initialize Gridstack editor on existing items
    (function(){
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/gridstack@10.1.2/dist/gridstack-all.min.js';
      s.onload = function(){
        const grid = GridStack.init({ float:false, cellHeight:120, margin: 16 }, container);
        const CELL = 120; // must match cellHeight
        const GUTTER = 16; // vertical gutter px
        try {
          container.style.display = 'grid';
          container.style.rowGap = GUTTER + 'px';
          container.style.columnGap = '8px';
        } catch(e) {}
        function applyGutter(){
          try {
            grid.engine.nodes.forEach(n => {
              n.el.style.transform = 'translateY(' + (n.y * GUTTER) + 'px)';
            });
            // Compute rows = max(y+h) across nodes (Gridstack in edit may not set gs-current-row)
            const rows = grid.engine && grid.engine.nodes && grid.engine.nodes.length
              ? grid.engine.nodes.reduce((m, n) => Math.max(m, (n.y||0) + (n.h||1)), 0)
              : 0;
            const h = (rows * CELL) + (Math.max(0, rows - 1) * GUTTER);
            container.style.height = h + 'px';
            container.style.position = 'relative';
          } catch(e) {}
        }
        applyGutter();
        // Delete via event delegation
        container.addEventListener('click', function(e){
          const btn = e.target.closest('.js-del-widget');
          if (!btn) return;
          const id = btn.getAttribute('data-id');
          if (!id || !confirm('Delete this block from layout?')) return;
          const el = btn.closest('.grid-stack-item');
          fetch(`${deleteUrlBase}${id}/delete/`, { method:'POST', headers:{ 'X-CSRFToken': csrftoken || '' } })
            .then(r => { if (r.ok) grid.removeWidget(el); else showToast('Failed to delete block', 'error'); })
            .catch(()=>showToast('Failed to delete block','error'));
        });
        function saveLayout(){
          const items = [];
          grid.engine.nodes.forEach(n => { items.push({ id: n.el.getAttribute('data-id'), x:n.x, y:n.y, w:n.w, h:n.h }); });
          fetch(gridSaveUrl, { method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRFToken': csrftoken || '' }, body: JSON.stringify({ items }) })
            .then(r => { if (!r.ok) showToast('Failed to save layout', 'error'); })
            .catch(() => showToast('Failed to save layout', 'error'));
        }
        grid.on('change', function(){ applyGutter(); saveLayout(); });
      };
      document.body.appendChild(s);
    })();

    // Auto-save span changes per row
    function collectRowPayload(tr) {
      const pickInt = function(name){
        const el = tr.querySelector(`[name$="-${name}"]`);
        if (!el) return undefined;
        const v = (el.value || '').trim();
        return v === '' ? null : parseInt(v, 10);
      };
      const pickStr = function(name){
        const el = tr.querySelector(`[name$="-${name}"]`);
        if (!el) return undefined;
        return (el.value || '').trim();
      };
      return {
        col_span: pickInt('col_span'),
        row_span: pickInt('row_span'),
        title: pickStr('title'),
        note: pickStr('note'),
        preferred_filter_name: pickStr('preferred_filter_name'),
        preferred_column_config_name: pickStr('preferred_column_config_name')
      };
    }
    // (Optional) additional inline metadata saving can be wired similarly

    // AJAX Add Block on select change
    (function(){
      const addForm = document.getElementById('add-block-form');
      if (!addForm) return;
      const sel = addForm.querySelector('select[name="block"]');
      if (!sel) return;
      sel.addEventListener('change', function(){
        const val = sel.value;
        if (!val) return;
        sel.disabled = true;
        fetch(addUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken || ''
          },
          body: JSON.stringify({block: val})
        }).then(function(resp){ return resp.json(); })
          .then(function(data){
            if (!data || !data.ok) { showToast('Failed to add block', 'error'); return; }
            // Reload page to fetch new block and render it (simple approach)
            window.location.reload();
          })
          .catch(function(){ showToast('Failed to add block', 'error'); })
          .finally(function(){ sel.disabled = false; sel.value = ''; });
      });
    })();
  });
</script>
<style>
  /* Force Grid layout + gaps (Gridstack v10 uses CSS Grid) */
  #grid-edit.grid-stack { --gs-gutter-rows: 16px !important; --gs-gutter-cols: 8px !important; }`r`n  #grid-edit.grid-stack { display: grid; row-gap: 16px; column-gap: 8px; }
  .grid-stack .grid-stack-item-content { overflow: auto; display:flex; flex-direction: column; min-height: 100%; }
  .grid-stack .grid-stack-item-content > div[id^="chart-"] { flex: 1 1 auto; }
  /* Fallback: enforce vertical spacing per item even if container isn't grid */
  .grid-stack .grid-stack-item { margin-bottom: 16px !important; }
</style>
{% endblock %}


