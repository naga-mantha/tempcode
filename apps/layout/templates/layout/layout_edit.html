{% extends "base.html" %}

{% load dict_extras %}
{% block content %}
  <div class="main-container-fluid">
    <h1 class="page-title">Edit Layout: {{ layout.name }}</h1>
    <p>
      <a href="{% url 'layout_detail' username=layout.user.username slug=layout.slug %}">Back to layout</a>
    </p>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Layout Details</h5>
        <form id="layout-details-form" method="post" action="{% url 'layout_rename' username=layout.user.username slug=layout.slug %}">
          {% csrf_token %}
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" name="name" value="{{ layout.name }}" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Category</label>
              <input type="text" class="form-control" name="category" value="{{ layout.category }}">
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" name="description" rows="3">{{ layout.description }}</textarea>
            </div>
            {# No layout-level title/notes; titles/notes are per-block below #}
          </div>
        </form>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Add Block</h5>
        <form method="post" id="add-block-form">
          {% csrf_token %}
          <div class="row g-2 align-items-end">
            <div class="col-md-8">
              <label class="form-label">Block</label>
              {{ add_form.block }}
            </div>
          </div>
        </form>
      </div>
    </div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@10.1.2/dist/gridstack.min.css">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <div class="grid-stack" id="grid-edit" style="gap:16px 8px; --gs-gutter-rows:16px; --gs-gutter-cols:8px;">
      {% for b in blocks %}
        <div class="grid-stack-item"
             gs-x="{{ b.x|default:0 }}"
             gs-y="{{ b.y|default:0 }}"
             gs-w="{{ b.w|default:4 }}"
             gs-h="{{ b.h|default:2 }}"
             data-id="{{ b.id }}"
             data-block-id="{{ b.id }}"
             data-dom-id="{{ b.dom_id|default:'' }}"
             data-block-kind="{{ b.kind|default:'' }}"
             data-preferred-filter="{{ b.preferred_filter_name|default_if_none:'' }}"
             data-preferred-setting="{{ b.preferred_setting_name|default_if_none:'' }}">
          <div class="grid-stack-item-content {% if not b.is_spacer %}card p-2{% endif %}">
            <div class="d-flex justify-content-end">
              <button type="button" class="btn btn-sm btn-outline-danger js-del-widget" data-id="{{ b.id }}">Delete</button>
            </div>
            {% if not b.is_spacer %}
              <div class="layout-block-pref-panel small bg-light border rounded p-2 mb-2" data-block-prefs data-block-id="{{ b.id }}" data-block-kind="{{ b.kind|default:'' }}">
                <div class="fw-semibold mb-1">Block defaults</div>
                <div class="d-flex flex-wrap align-items-center gap-3" data-role="pref-groups">
                  <div class="d-flex align-items-center gap-2" data-role="filter-group">
                    <span class="text-muted">Default filter</span>
                    <select class="form-select form-select-sm js-block-pref-select js-block-pref-filter"
                            data-placeholder="-- None --"
                            data-current="{{ b.preferred_filter_name|default_if_none:'' }}">
                      <option value="">-- None --</option>
                    </select>
                  </div>
                  <div class="d-flex align-items-center gap-2" data-role="setting-group">
                    <span class="text-muted">Default setting</span>
                    <select class="form-select form-select-sm js-block-pref-select js-block-pref-setting"
                            data-placeholder="-- None --"
                            data-current="{{ b.preferred_setting_name|default_if_none:'' }}">
                      <option value="">-- None --</option>
                    </select>
                  </div>
                </div>
                <div class="small mt-2 text-muted d-none" data-role="pref-status"></div>
              </div>
            {% endif %}
            {{ b.html|safe }}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
{% endblock %}

{% block scripts %}
{% load static %}
<script src="{% static 'common/js/table-filters.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('grid-edit');
    const detailsForm = document.getElementById('layout-details-form');
    const gridSaveUrl = "{% url 'layout_grid_update' username=layout.user.username slug=layout.slug %}";
    const updateUrlTemplate = "{% url 'layout_block_update' username=layout.user.username slug=layout.slug lb_id=0 %}";
    const deleteUrlTemplate = "{% url 'layout_block_delete' username=layout.user.username slug=layout.slug lb_id=0 %}";
    const addUrl = "{% url 'layout_block_add' username=layout.user.username slug=layout.slug %}";
    const configsUrlTemplate = "{% url 'layout_block_configs' username=layout.user.username slug=layout.slug lb_id=0 %}";

    function buildBlockUrl(template, id) {
      return template.replace('/0/', '/' + String(id) + '/');
    }

    // CSRF helper
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    function getCsrfToken() {
      return getCookie('csrftoken') || (document.querySelector('input[name="csrfmiddlewaretoken"]') || {}).value || '';
    }
    const csrftoken = getCsrfToken();

    // Simple toast for error/success messages
    function showToast(message, variant) {
      const id = 'js-toast-container';
      let c = document.getElementById(id);
      if (!c) {
        c = document.createElement('div');
        c.id = id;
        c.style.position = 'fixed';
        c.style.right = '16px';
        c.style.bottom = '16px';
        c.style.zIndex = '1080';
        c.style.display = 'flex';
        c.style.flexDirection = 'column';
        c.style.gap = '8px';
        document.body.appendChild(c);
      }
      const el = document.createElement('div');
      el.textContent = message || 'An error occurred';
      el.style.padding = '10px 14px';
      el.style.borderRadius = '4px';
      el.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
      el.style.color = '#fff';
      el.style.fontSize = '14px';
      el.style.opacity = '0';
      el.style.transition = 'opacity .2s ease';
      el.style.background = (variant === 'success') ? '#198754' : (variant === 'warning' ? '#fd7e14' : '#dc3545');
      c.appendChild(el);
      requestAnimationFrame(function(){ el.style.opacity = '1'; });
      setTimeout(function(){ el.style.opacity = '0'; setTimeout(function(){ el.remove(); }, 200); }, 3000);
    }

    // Auto-save layout name/description via AJAX with debounce
    (function(){
      if (!detailsForm) return;
      const nameEl = detailsForm.querySelector('input[name="name"]');
      const catEl = detailsForm.querySelector('input[name="category"]');
      const descEl = detailsForm.querySelector('textarea[name="description"]');
      let timer = null;
      function scheduleSave(){
        if (timer) clearTimeout(timer);
        timer = setTimeout(doSave, 400);
      }
      function doSave(){
        const payload = {
          name: (nameEl && nameEl.value || '').trim(),
          category: (catEl && catEl.value || '').trim(),
          description: (descEl && descEl.value || '').trim()
        };
        fetch(detailsForm.action, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRFToken': csrftoken || ''
          },
          body: JSON.stringify(payload)
        }).then(function(resp){ return resp.json().catch(function(){ return { ok:false }; }); })
          .then(function(data){
            if (!data || !data.ok) { showToast('Failed to save layout details', 'error'); return; }
            // If slug changed, reload to the new Edit URL to refresh dependent URLs
            const currentPath = window.location.pathname;
            if (data.edit_url && currentPath !== data.edit_url) {
              window.location.href = data.edit_url;
              return;
            }
            // Update page title
            const h1 = document.querySelector('h1.page-title');
            if (h1 && data.name) h1.textContent = 'Edit Layout: ' + data.name;
            // Update back link if provided
            const backLink = document.querySelector('a[href*="{% url 'layout_detail' username=layout.user.username slug=layout.slug %}"]');
            if (backLink && data.detail_url) backLink.setAttribute('href', data.detail_url);
            showToast('Saved', 'success');
          })
          .catch(function(){ showToast('Failed to save layout details', 'error'); });
      }
      if (nameEl) nameEl.addEventListener('input', scheduleSave);
      if (catEl) catEl.addEventListener('input', scheduleSave);
      if (descEl) descEl.addEventListener('input', scheduleSave);
    })();

    // Hook delete buttons on grid items
    container.addEventListener('click', function(e){
      const btn = e.target.closest('.js-del-widget');
      if (!btn) return;
      e.preventDefault();
      const idStr = btn.getAttribute('data-id');
      const id = parseInt(idStr, 10);
      if (isNaN(id) || !confirm('Delete this block from layout?')) return;
      const itemEl = btn.closest('.grid-stack-item');
      fetch(buildBlockUrl(deleteUrlTemplate, id), {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'X-CSRFToken': csrftoken || '', 'Accept': 'application/json' }
      }).then(async (resp) => {
        if (resp.ok) {
          try { const grid = container.gridstack; grid?.removeWidget(itemEl); } catch (_) { itemEl?.remove(); }
        } else {
          const txt = await resp.text().catch(()=> '');
          showToast('Failed to delete block' + (txt?`: ${txt}`:''), 'error');
        }
      }).catch(() => showToast('Failed to delete block', 'error'));
    });

    // Debounced per-block Title/Notes updater
    (function(){
      const pending = new Map();
      function schedule(id, data){
        const key = String(id);
        if (pending.has(key)) clearTimeout(pending.get(key));
        const t = setTimeout(() => doUpdate(id, data), 300);
        pending.set(key, t);
      }
      function doUpdate(id, data){
        fetch(buildBlockUrl(updateUrlTemplate, id), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken || '' },
          body: JSON.stringify(data || {})
        }).then(r => {
          if (!r.ok) showToast('Failed to save block details', 'error');
        }).catch(() => showToast('Failed to save block details', 'error'));
      }
      container.addEventListener('input', function(e){
        const titleEl = e.target.closest('.js-block-title');
        const notesEl = e.target.closest('.js-block-notes');
        if (!titleEl && !notesEl) return;
        const el = titleEl || notesEl;
        const id = parseInt(el.getAttribute('data-id'), 10);
        if (isNaN(id)) return;
        const data = {};
        if (titleEl) data.title = (titleEl.value || '').trim();
        if (notesEl) data.note = (notesEl.value || '').trim();
        schedule(id, data);
      });
    })();

    function initOrderFields() {
      const rows = container.querySelectorAll('.layout-item');
      rows.forEach(function(tr, idx){
        const orderInput = tr.querySelector('input[type="number"][name$="-ORDER"]');
        if (orderInput) orderInput.value = idx + 1;
      });
    }
    // Initialize Gridstack editor on existing items
    (function(){
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/gridstack@10.1.2/dist/gridstack-all.min.js';
      s.onload = function(){
        // Natural Gridstack: fixed columns, no JS-driven responsiveness
        const grid = GridStack.init({ float:false, cellHeight:136, margin: 8 }, container);
        function saveLayout(){
          const items = [];
          grid.engine.nodes.forEach(n => { const idStr = n.el.getAttribute('data-id'); const id = parseInt(idStr, 10); if (!isNaN(id)) { items.push({ id: id, x:n.x, y:n.y, w:n.w, h:n.h }); } });
          fetch(gridSaveUrl, { method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRFToken': csrftoken || '' }, body: JSON.stringify({ items }) })
            .then(r => { if (!r.ok) showToast('Failed to save layout', 'error'); })
            .catch(() => showToast('Failed to save layout', 'error'));
        }
        grid.on('change', function(){ saveLayout(); });
      };
      document.body.appendChild(s);
    })();

    // Auto-save span changes per row
    function collectRowPayload(tr) {
      const pickInt = function(name){
        const el = tr.querySelector(`[name$="-${name}"]`);
        if (!el) return undefined;
        const v = (el.value || '').trim();
        return v === '' ? null : parseInt(v, 10);
      };
      const pickStr = function(name){
        const el = tr.querySelector(`[name$="-${name}"]`);
        if (!el) return undefined;
        return (el.value || '').trim();
      };
      return {
        col_span: pickInt('col_span'),
        row_span: pickInt('row_span'),
        title: pickStr('title'),
        note: pickStr('note'),
        preferred_filter_name: pickStr('preferred_filter_name'),
        preferred_setting_name: pickStr('preferred_setting_name')
      };
    }
    // (Optional) additional inline metadata saving can be wired similarly

    // AJAX Add Block on select change
    (function(){
      const addForm = document.getElementById('add-block-form');
      if (!addForm) return;
      const sel = addForm.querySelector('select[name="block"]');
      if (!sel) return;
      sel.addEventListener('change', function(){
        const val = sel.value;
        if (!val) return;
        sel.disabled = true;
        fetch(addUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken || ''
          },
          body: JSON.stringify({block: val})
        }).then(function(resp){ return resp.json(); })
          .then(function(data){
            if (!data || !data.ok) { showToast('Failed to add block', 'error'); return; }
            // Reload page to fetch new block and render it (simple approach)
            window.location.reload();
          })
          .catch(function(){ showToast('Failed to add block', 'error'); })
          .finally(function(){ sel.disabled = false; sel.value = ''; });
      });
    })();

    // Per-block default filter/setting controls
    (function(){
      const prefPanels = container.querySelectorAll('[data-block-prefs]');
      if (!prefPanels.length) return;

      const configUrl = function(id){
        return buildBlockUrl(configsUrlTemplate, id);
      };
      const updateUrl = function(id){
        return buildBlockUrl(updateUrlTemplate, id);
      };

      function namesEqual(a, b){
        return (a || '').trim().toLowerCase() === (b || '').trim().toLowerCase();
      }

      function populateSelect(select, items, current){
        if (!select) return;
        const placeholder = select.dataset.placeholder || '-- None --';
        select.innerHTML = '';
        const noneOpt = document.createElement('option');
        noneOpt.value = '';
        noneOpt.textContent = placeholder;
        select.appendChild(noneOpt);
        let matched = false;
        (items || []).forEach(function(name){
          if (typeof name !== 'string') return;
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          if (current && namesEqual(name, current)) {
            opt.selected = true;
            matched = true;
          }
          select.appendChild(opt);
        });
        if (current && !matched) {
          const opt = document.createElement('option');
          opt.value = current;
          opt.textContent = `${current} (missing)`;
          opt.selected = true;
          select.appendChild(opt);
        }
        select.dataset.ready = '1';
      }

      function toggleGroup(group, hasOptions){
        if (!group) return;
        if (hasOptions) {
          group.classList.remove('d-none');
        } else {
          group.classList.add('d-none');
        }
      }

      function setStatus(panel, message, variant){
        const statusEl = panel.querySelector('[data-role="pref-status"]');
        if (!statusEl) return;
        if (!message) {
          statusEl.classList.add('d-none');
          statusEl.textContent = '';
          statusEl.classList.remove('text-danger');
          statusEl.classList.remove('text-success');
          return;
        }
        statusEl.textContent = message;
        statusEl.classList.remove('d-none');
        statusEl.classList.toggle('text-danger', variant === 'error');
        statusEl.classList.toggle('text-success', variant === 'success');
      }

      prefPanels.forEach(function(panel){
        const blockId = parseInt(panel.dataset.blockId || '', 10);
        if (!Number.isFinite(blockId)) {
          panel.classList.add('d-none');
          return;
        }
        const filterSelect = panel.querySelector('.js-block-pref-filter');
        const settingSelect = panel.querySelector('.js-block-pref-setting');
        const currentFilter = filterSelect ? filterSelect.dataset.current || '' : '';
        const currentSetting = settingSelect ? settingSelect.dataset.current || '' : '';
        const kind = (panel.dataset.blockKind || '').toLowerCase();
        if (filterSelect) {
          filterSelect.disabled = true;
        }
        if (settingSelect) {
          settingSelect.disabled = true;
        }
        fetch(configUrl(blockId), { headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' } })
          .then(function(resp){ if (!resp.ok) throw new Error('Failed to load options'); return resp.json(); })
          .then(function(data){
            const filters = (data && Array.isArray(data.filters)) ? data.filters : [];
            const settings = (data && Array.isArray(data.settings)) ? data.settings : [];
            const selected = (data && data.selected) || {};
            if (filterSelect) {
              const initial = typeof selected.filter === 'string' && selected.filter ? selected.filter : currentFilter;
              populateSelect(filterSelect, filters, initial);
              filterSelect.disabled = filters.length === 0;
              toggleGroup(panel.querySelector('[data-role="filter-group"]'), filters.length > 0);
            }
            if (settingSelect) {
              let initialSetting = currentSetting;
              if (typeof selected.setting === 'string' && selected.setting) {
                initialSetting = selected.setting;
              } else if (kind === 'pivot' && typeof selected.pivot === 'string' && selected.pivot) {
                initialSetting = selected.pivot;
              }
              populateSelect(settingSelect, settings, initialSetting);
              settingSelect.disabled = settings.length === 0;
              toggleGroup(panel.querySelector('[data-role="setting-group"]'), settings.length > 0);
            }
            if ((!filters || !filters.length) && (!settings || !settings.length)) {
              panel.classList.add('d-none');
            }
            setStatus(panel, '', null);
          })
          .catch(function(){
            setStatus(panel, 'Unable to load block defaults.', 'error');
            if (filterSelect) { filterSelect.disabled = true; }
            if (settingSelect) { settingSelect.disabled = true; }
          });
      });

      container.addEventListener('change', function(ev){
        const select = ev.target.closest('.js-block-pref-select');
        if (!select || select.dataset.ready !== '1') return;
        const panel = select.closest('[data-block-prefs]');
        if (!panel) return;
        const blockId = parseInt(panel.dataset.blockId || '', 10);
        if (!Number.isFinite(blockId)) return;
        const filterSelect = panel.querySelector('.js-block-pref-filter');
        const settingSelect = panel.querySelector('.js-block-pref-setting');
        const payload = new URLSearchParams();
        if (filterSelect) {
          payload.append('preferred_filter_name', filterSelect.value || '');
        }
        if (settingSelect) {
          payload.append('preferred_setting_name', settingSelect.value || '');
        }
        setStatus(panel, 'Savingâ€¦', null);
        fetch(updateUrl(blockId), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
            'X-CSRFToken': csrftoken || '',
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: payload.toString(),
        }).then(function(resp){
          if (!resp.ok) throw new Error('Failed to save');
          setStatus(panel, 'Preferences saved.', 'success');
          showToast('Saved block defaults', 'success');
        }).catch(function(){
          setStatus(panel, 'Unable to save defaults.', 'error');
          showToast('Failed to save block defaults', 'error');
        });
      });
    })();
  });
</script>
<style>
  /* Force Grid layout + gaps (Gridstack v10 uses CSS Grid) */
  #grid-edit.grid-stack { --gs-gutter-rows: 16px !important; --gs-gutter-cols: 8px !important; }`r`n  #grid-edit.grid-stack { display: grid; row-gap: 16px; column-gap: 8px; }
  .grid-stack .grid-stack-item-content { overflow: auto; display:flex; flex-direction: column; min-height: 100%; }
  .grid-stack .grid-stack-item-content > div[id^="chart-"] { flex: 1 1 auto; }
  /* Ensure wrapped block root grows to fill tile and inner containers flex */
  .grid-stack .grid-stack-item-content > .js-layout-block-root { display:flex; flex-direction: column; min-height: 100%; position: relative; }
  .grid-stack .grid-stack-item-content .js-layout-block-root > div[id^="chart-"] { flex: 1 1 auto; }
  .grid-stack .grid-stack-item-content .js-layout-block-root > div[id^="table-"] { flex: 1 1 auto; }
  /* Ensure grid container can expand to full width */
  #grid-edit { width: 100%; max-width: 100%; }
  .layout-block-pref-panel { background-color: #f8f9fa; }
  .layout-block-pref-panel select { min-width: 140px; }
</style>
{% endblock %}



