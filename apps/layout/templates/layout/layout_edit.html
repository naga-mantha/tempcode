<h1>Edit Layout: {{ layout.name }}</h1>
<p>
  <a href="{% url 'layout_detail' username=layout.user.username slug=layout.slug %}">Back to layout</a>
</p>

<form method="post">
  {% csrf_token %}
  {{ formset.management_form }}
  <table class="table">
    <thead>
      <tr>
        <th>Block</th>
        <th>Row</th>
        <th>Col (width)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for form in formset %}
        <tr>
          <td>
            {{ form.instance.block.name }}
            {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
          </td>
          <td>{{ form.row }}</td>
          <td>{{ form.col }}</td>
          <td>
            {# Render DELETE field (from can_delete) and hide it visually #}
            <span style="display:none;">{{ form.DELETE }}</span>
            <button type="button" class="btn btn-sm btn-outline-danger"
                    onclick="(function(btn){
                      if(!confirm('Delete this block from layout?')) return;
                      const tr = btn.closest('tr');
                      const del = tr && tr.querySelector('input[type=checkbox][name$="-DELETE"]');
                      if(del){ del.checked = true; }
                      btn.form.submit();
                    })(this)">
              Delete
            </button>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  <button type="submit" class="btn btn-primary">Save</button>
</form>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const table = document.querySelector('table');
    if (!table) return;
    const buttons = table.querySelectorAll('button[onclick]');
    buttons.forEach(function(btn){
      if ((btn.textContent || '').trim() !== 'Delete') return;
      // Replace brittle inline handler with a safe listener
      btn.removeAttribute('onclick');
      btn.addEventListener('click', function(e){
        e.preventDefault();
        if(!confirm('Delete this block from layout?')) return;
        const tr = btn.closest('tr');
        const del = tr && tr.querySelector('input[type=checkbox][name$="-DELETE"]');
        if (del) { del.checked = true; }
        btn.form && btn.form.submit();
      });
    });
  });
  </script>
