{% load dict_extras %}

<div id="{{ dom_wrapper_id }}" class="card shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div class="fw-semibold">{{ title }}</div>
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <label class="mb-0 small text-muted">View</label>
      <select class="form-select form-select-sm w-auto" onchange="(function(sel){ try{ var params=new URLSearchParams(window.location.search||''); if(sel.value){ params.set('config_id', sel.value);} else { params.delete('config_id'); } var dest=window.location.pathname + (params.toString() ? ('?'+params.toString()) : ''); window.location.assign(dest); }catch(e){ window.location.href=window.location.pathname + '?config_id=' + encodeURIComponent(sel.value||''); } })(this)">
        <option value="">(Default)</option>
        {% if table_configs %}
          <optgroup label="Private views">
            {% for cfg in table_configs %}
              {% if cfg.user_id == request.user.id and cfg.visibility == 'private' %}
                <option value="{{ cfg.id }}" {% if cfg.id == active_table_config_id %}selected{% endif %}>{{ cfg.name }}</option>
              {% endif %}
            {% endfor %}
          </optgroup>
          <optgroup label="Public views">
            {% for cfg in table_configs %}
              {% if cfg.visibility == 'public' %}
                <option value="{{ cfg.id }}" {% if cfg.id == active_table_config_id %}selected{% endif %}>{{ cfg.name }}</option>
              {% endif %}
            {% endfor %}
          </optgroup>
        {% endif %}
      </select>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'blocks_v2:manage_columns' spec_id %}">Table Settings</a>
      {% if spec_id == 'v2.items.table' %}
        <a class="btn btn-sm btn-outline-secondary" href="{% url 'blocks_v2:table_items' %}">Table Link</a>
      {% elif spec_id == 'v2.layouts.table' %}
        <a class="btn btn-sm btn-outline-secondary" href="{% url 'blocks_v2:table_layouts' %}">Table Link</a>
      {% else %}
        <a class="btn btn-sm btn-outline-secondary" href="{% url 'blocks_v2:render_spec' spec_id %}">Table Link</a>
      {% endif %}
      <span class="mx-1 text-muted">—</span>
      <label class="mb-0 small text-muted">Filter</label>
      <select id="filterCfgSelect-{{ dom_id }}" class="form-select form-select-sm w-auto" onchange="return v2FilterSelectChange_{{ dom_id|slugify|cut:"-" }}(this)">
        <option value="">(None)</option>
        {% if filter_configs %}
          <optgroup label="Private filters">
            {% for cfg in filter_configs %}
              {% if cfg.user_id == request.user.id and cfg.visibility == 'private' %}
                <option value="{{ cfg.id }}" {% if cfg.id == active_filter_config_id %}selected{% endif %}>{{ cfg.name }}{% if cfg.is_default %} (default){% endif %}</option>
              {% endif %}
            {% endfor %}
          </optgroup>
          <optgroup label="Public filters">
            {% for cfg in filter_configs %}
              {% if cfg.visibility == 'public' %}
                <option value="{{ cfg.id }}" {% if cfg.id == active_filter_config_id %}selected{% endif %}>{{ cfg.name }}{% if cfg.is_default %} (default){% endif %}</option>
              {% endif %}
            {% endfor %}
          </optgroup>
        {% endif %}
      </select>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'blocks_v2:manage_filters' spec_id %}">Filter Settings</a>
      <span class="mx-1 text-muted">—</span>
      <button type="button" class="btn btn-sm btn-outline-secondary"
              title="Download to Excel"
              onclick="(function(id){ var t=window[id]; if(!t){ alert('Table not ready'); return; } if(!window.XLSX){ console.warn('XLSX lib missing'); } t.download('xlsx', '{{ spec_id|default:'table' }}.xlsx', {sheetName: '{{ title|default:'Sheet1' }}'}); })('{{ dom_id }}')">
        Download to Excel
      </button>
      <button type="button" class="btn btn-sm btn-outline-secondary"
              title="Download to PDF"
              onclick="(function(id){ var t=window[id]; if(!t){ alert('Table not ready'); return; } try { if (window.jspdf && window.jspdf.jsPDF && !window.jsPDF) { window.jsPDF = window.jspdf.jsPDF; } } catch(e){} t.download('pdf', '{{ spec_id|default:'table' }}.pdf', { orientation: 'portrait', title: '{{ title|default:'Table' }}', jsPDF: { unit: 'pt', format: 'a4', compress: true }, autoTable: { styles: { halign: 'left', overflow: 'linebreak' }}}); })('{{ dom_id }}')">
        Download to PDF
      </button>
      <div class="btn-group">
        <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
          Server Export
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="#" onclick="exportServer('{{ spec_id }}','csv','{{ dom_wrapper_id }}', {{ active_table_config_id|default:'null' }})">CSV</a></li>
          <li><a class="dropdown-item" href="#" onclick="exportServer('{{ spec_id }}','xlsx','{{ dom_wrapper_id }}', {{ active_table_config_id|default:'null' }})">Excel</a></li>
        </ul>
      </div>
      <span class="text-muted small">V2</span>
    </div>
  </div>
  <div class="card-body">
    <div class="htmx-indicator spinner-border spinner-border-sm text-secondary" role="status" style="display:none"></div>
    <form id="v2TableFilterForm-{{ dom_id }}" onsubmit="return applyV2Filters_{{ dom_id|slugify|cut:"-" }}(this)">
      <input type="hidden" name="config_id" value="{{ active_table_config_id|default:'' }}">
      <input type="hidden" name="filter_config_id" value="{{ active_filter_config_id|default:'' }}">
      <div class="accordion mb-3" id="accordion-{{ dom_id }}">
        <div class="accordion-item">
          <h2 class="accordion-header" id="heading-{{ dom_id }}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ dom_id }}" aria-expanded="false" aria-controls="collapse-{{ dom_id }}">
              Filter Conditions
            </button>
          </h2>
          <div id="collapse-{{ dom_id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ dom_id }}" data-bs-parent="#accordion-{{ dom_id }}">
            <div class="accordion-body">
              {% if filter_schema %}
                {% include "components/filter_fields.html" with filter_schema=filter_schema initial_values=filters filter_layout=filter_layout name_prefix="" id_prefix=dom_id %}
                <div class="mt-2">
                  <button type="submit" class="btn btn-sm btn-primary">Apply Filters</button>
                </div>
              {% else %}
                <div class="text-muted small">No filter schema defined.</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </form>

    <div id="{{ dom_table_id }}" class="border rounded" style="height: 520px;"></div>
    <noscript>
      <div class="text-muted small mt-3">Enable JavaScript to view the interactive table.</div>
    </noscript>
  </div>
</div>

<!-- removed unused Save View and Save Filter modals to slim template -->

<script>
  (function () {
    const serverColumns = {{ columns|tojson }};
    const tableOptions = {{ table_options|tojson }};
    const tableEl = document.getElementById('{{ dom_table_id }}');
    if (!tableEl || typeof Tabulator === 'undefined') return;

    const columns = serverColumns.map(c => ({
      title: c.label,
      field: c.key,
      headerFilter: true,
    }));

    const table = new Tabulator(tableEl, {
      columns,
      layout: 'fitColumns',
      pagination: true,
      paginationMode: 'remote',
      paginationSize: 10,
      paginationSizeSelector: [10, 25, 50, 100],
      dataReceiveParams: { last_page: 'last_page', data: 'data' },
      movableColumns: true,
      initialSort: (columns.length ? [{column: columns[0].field, dir: 'asc'}] : []),
      placeholder: 'No data',
      ajaxURL: '{{ data_url }}',
      ajaxURLGenerator: function(url, config, params){
        const p = new URLSearchParams(window.location.search || '');
        p.set('page', params.page || 1);
        p.set('size', params.size || (tableOptions && tableOptions.paginationSize) || 10);
        if (Array.isArray(params.sorters) && params.sorters.length){
          const s = params.sorters[0];
          if (s && s.field){ p.set('sort', s.field); p.set('dir', s.dir || 'asc'); }
        } else {
          p.delete('sort'); p.delete('dir');
        }
        // Include current simple filters from the accordion form
        try {
          const form = document.getElementById('v2TableFilterForm-{{ dom_id }}');
          if (form){
            const fdata = new FormData(form);
            for (const [k, v] of fdata.entries()){
              if (v !== '') p.set(k, v);
            }
          }
        } catch(e){}
        // Ensure saved filter id reflects current dropdown
        try {
          const sel = document.getElementById('filterCfgSelect-{{ dom_id }}');
          if (sel && sel.value) { p.set('filter_config_id', sel.value); }
        } catch(e){}
        return url + '?' + p.toString();
      },
      ...tableOptions
    });
    // Ensure jsPDF alias if using UMD build
    try { if (window.jspdf && window.jspdf.jsPDF && !window.jsPDF) { window.jsPDF = window.jspdf.jsPDF; } } catch (e) {}
    window['{{ dom_id }}'] = table; // debug handle per-block
  })();
</script>
<script>
  function v2FilterSelectChange_{{ dom_id|slugify|cut:"-" }}(sel){
    try{
      var params = new URLSearchParams(window.location.search||'');
      if (sel && sel.value) { params.set('filter_config_id', sel.value); } else { params.delete('filter_config_id'); }
      // Clear ad-hoc filter params so saved filter takes full effect
      try {
        var schemaMap = {{ filter_schema|tojson }} || {};
        var keys = (typeof schemaMap === 'object' && schemaMap) ? Object.keys(schemaMap) : [];
        keys.forEach(function(k){ params.delete(k); params.delete('filters.' + k); });
      } catch(e){}
      var dest = window.location.pathname + (params.toString()?('?'+params.toString()):'');
      window.location.assign(dest);
    } catch(e) {
      window.location.href = window.location.pathname + (sel && sel.value ? ('?filter_config_id='+encodeURIComponent(sel.value)) : '');
    }
    return false;
  }
  function applyV2Filters_{{ dom_id|slugify|cut:"-" }}(form){
    try{
      var params = new URLSearchParams(window.location.search||'');
      // Preserve selected view/filter ids
      var cfg = form.querySelector('input[name="config_id"]')?.value || '';
      var filt = form.querySelector('input[name="filter_config_id"]')?.value || '';
      if (cfg) params.set('config_id', cfg); else params.delete('config_id');
      if (filt) params.set('filter_config_id', filt); else params.delete('filter_config_id');
      // Apply current filter inputs (overwrite or clear empty)
      var fd = new FormData(form);
      for (const [k,v] of fd.entries()){
        if (k === 'config_id' || k === 'filter_config_id') continue;
        if (v === '') { params.delete(k); } else { params.set(k, v); }
      }
      var dest = window.location.pathname + (params.toString()?('?'+params.toString()):'');
      window.location.assign(dest);
    }catch(e){ console.warn('Apply filters failed', e); }
    return false;
  }
  (function(){
    try {
      // Initialize TomSelect for dynamic filter fields within accordion using data-ajax-url
      if (window.TomSelect){
        document.querySelectorAll('#v2TableFilterForm-{{ dom_id }} select.filter-field-select').forEach(function(sel){
          var ajaxUrl = sel.getAttribute('data-ajax-url');
          var opts = {};
          try { var raw = sel.getAttribute('data-tom-select-options'); if (raw) opts = JSON.parse(raw); } catch(e){}
          var minLen = 3;
          if (ajaxUrl){
            new TomSelect(sel, Object.assign({
              valueField: 'value',
              labelField: 'label',
              searchField: 'label',
              persist: false,
              closeAfterSelect: true,
              preload: 'focus',
              openOnFocus: true,
              placeholder: 'Type at least ' + minLen + ' characters',
              load: function(query, callback){
                if (!query || query.length < minLen) { callback(); return; }
                var p = new URLSearchParams();
                p.set('q', query);
                try { const form = document.getElementById('v2TableFilterForm-{{ dom_id }}'); if (form){ const fd=new FormData(form); for (const [k,v] of fd.entries()) { if (v !== '') p.append(k,v); } } } catch(e){}
                fetch(ajaxUrl + '?' + p.toString(), {headers: {'X-Requested-With':'XMLHttpRequest'}})
                  .then(r => r.json()).then(resp => callback(resp.results || []))
                  .catch(() => callback());
              }
            }, opts));
          }
        });
      }
    } catch (e) { console.warn('TomSelect init failed', e); }
  })();
</script>
<script>
  function exportServer(specId, fmt, wrapperId, activeCfgId){
    try{
      var base = '{% url "blocks_v2:export_spec" spec_id "csv" %}'.replace('csv', fmt);
      var params = new URLSearchParams(window.location.search||'');
      if (activeCfgId) params.set('config_id', activeCfgId);
      try { var sel = document.getElementById('filterCfgSelect-{{ dom_id }}'); if (sel && sel.value) params.set('filter_config_id', sel.value); } catch(e){}
      var form = document.querySelector('#' + wrapperId + ' form');
      if (form){ const fd = new FormData(form); for (const [k,v] of fd.entries()) { if (v !== '') params.set(k, v); } }
      var url = base + (params.toString() ? ('?' + params.toString()) : '');
      window.location.href = url;
    } catch(e){ alert('Export failed'); }
  }
  // Basic HTMX error handler for this block
  document.addEventListener('htmx:responseError', function(ev) {
    try {
      var card = document.getElementById('{{ dom_wrapper_id }}');
      if (!card) return;
      var note = document.createElement('div');
      note.className = 'alert alert-danger mt-2';
      note.textContent = 'Error refreshing block.';
      var body = card.querySelector('.card-body');
      if (body) { body.prepend(note); setTimeout(function(){ note.remove(); }, 3000); }
    } catch(e) {}
  });
</script>

