{% extends "base.html" %}

{% block title %}<title>Manage Columns — {{ spec.name }}</title>{% endblock %}

{% block content %}
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Manage Columns — {{ spec.name }}</h5>
    <div>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'blocks_v2:table_layouts' %}">Back</a>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-5">
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center gap-2">
            <div>Available Fields</div>
            <div class="d-flex align-items-center gap-2">
              <label class="mb-0 small text-muted">Depth</label>
              <select class="form-select form-select-sm w-auto" onchange="(function(sel){ const url=new URL(window.location.href); url.searchParams.set('depth', sel.value); window.location.href=url.toString(); })(this)">
                <option value="0" {% if depth == 0 %}selected{% endif %}>0</option>
                <option value="1" {% if depth == 1 %}selected{% endif %}>1</option>
                <option value="2" {% if depth == 2 %}selected{% endif %}>2</option>
                <option value="3" {% if depth == 3 %}selected{% endif %}>3</option>
              </select>
              <input type="search" id="availSearch" class="form-control form-control-sm w-auto" placeholder="Search">
            </div>
          </div>
        </div>
        <div class="card-body">
          <ul id="availableList" class="list-group small">
            {% for item in available %}
            <li class="list-group-item d-flex align-items-center justify-content-between" data-key="{{ item.key }}">
              <div>
                <span class="me-2 bi bi-grip-vertical"></span>
                <span>{{ item.label }}</span>
                <small class="text-muted ms-2">({{ item.key }})</small>
              </div>
              <span class="badge text-bg-light border">{{ item.type|default:'text' }}</span>
            </li>
            {% empty %}
            <li class="list-group-item text-muted">No more fields</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    <div class="col-md-7">
      <div class="card">
        <div class="card-header">Selected Fields (drag to reorder)</div>
        <div class="card-body">
          <ul id="selectedList" class="list-group small">
            {% for item in selected %}
            <li class="list-group-item d-flex align-items-center justify-content-between" data-key="{{ item.key }}">
              <div>
                <span class="me-2 bi bi-grip-vertical"></span>
                <span>{{ item.label }}</span>
                <small class="text-muted ms-2">({{ item.key }})</small>
              </div>
              <span class="badge text-bg-light border">{{ item.type|default:'text' }}</span>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header">Save View</div>
        <div class="card-body">
          <form id="saveManageForm" hx-post="{% url 'blocks_v2:save_table_config' spec_id %}" hx-swap="none">
            {% csrf_token %}
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label">Name</label>
                <input type="text" name="name" class="form-control" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Visibility</label>
                <select name="visibility" class="form-select">
                  <option value="private">Private</option>
                  <option value="public">Public</option>
                </select>
              </div>
              <div class="col-md-3 d-flex align-items-end">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="is_default" id="mkDefault">
                  <label class="form-check-label" for="mkDefault">Make default</label>
                </div>
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-primary" onclick="saveManageColumns()">Save</button>
              </div>
            </div>
            <input type="hidden" name="columns_json" id="manageColsJson">
          </form>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header">My Views</div>
        <div class="card-body">
          {% if table_configs %}
            <ul class="list-group">
              {% for cfg in table_configs %}
                {% if cfg.user_id == request.user.id %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>
                    {{ cfg.name }}
                    {% if cfg.is_default %}<span class="badge text-bg-secondary ms-2">default</span>{% endif %}
                    <span class="badge text-bg-light border ms-2">{{ cfg.visibility }}</span>
                  </span>
                  <span class="btn-group">
                    <form method="post" action="{% url 'blocks_v2:rename_table_config' spec_id cfg.id %}" class="d-inline" onsubmit="return renameCfg{{ cfg.id }}()">
                      {% csrf_token %}
                      <input type="hidden" name="name" id="rn{{ cfg.id }}">
                      <button type="submit" class="btn btn-sm btn-outline-secondary">Rename</button>
                    </form>
                    <form method="post" action="{% url 'blocks_v2:make_default_table_config' spec_id cfg.id %}" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-outline-secondary" {% if cfg.is_default %}disabled{% endif %}>Make Default</button>
                    </form>
                    <form method="post" action="{% url 'blocks_v2:toggle_visibility_table_config' spec_id cfg.id %}" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-outline-secondary">{% if cfg.visibility == 'private' %}Make Public{% else %}Make Private{% endif %}</button>
                    </form>
                    <form method="post" action="{% url 'blocks_v2:duplicate_table_config' spec_id cfg.id %}" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-outline-secondary">Duplicate</button>
                    </form>
                    <form method="post" action="{% url 'blocks_v2:delete_table_config' spec_id cfg.id %}" class="d-inline" onsubmit="return confirm('Delete view {{ cfg.name }}?')">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                    </form>
                  </span>
                </li>
                <script>
                  function renameCfg{{ cfg.id }}(){
                    var name = prompt('New name for {{ cfg.name }}:', '{{ cfg.name }}');
                    if (!name) return false; document.getElementById('rn{{ cfg.id }}').value = name; return true;
                  }
                </script>
                {% endif %}
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-muted small">No saved views yet.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function(){
    // Filter available by search
    const input = document.getElementById('availSearch');
    const list = document.getElementById('availableList');
    input?.addEventListener('input', function(){
      const q = this.value.toLowerCase();
      list.querySelectorAll('li[data-key]').forEach(function(li){
        const text = li.textContent.toLowerCase();
        li.style.display = text.includes(q) ? '' : 'none';
      });
    });

    // Init SortableJS (assumes bundled in vendor)
    try {
      if (window.Sortable) {
        const common = {group: 'cols', handle: '.bi-grip-vertical', animation: 150};
        window.__v2AvailSort = new Sortable(availableList, common);
        window.__v2SelSort = new Sortable(selectedList, common);
      }
    } catch (e) { console.warn('Sortable init failed', e); }
  })();

  function saveManageColumns(){
    try {
      var keys = Array.from(document.querySelectorAll('#selectedList li[data-key]')).map(function(li){ return li.getAttribute('data-key'); });
      document.getElementById('manageColsJson').value = JSON.stringify(keys);
      document.getElementById('saveManageForm').requestSubmit();
    } catch (e) { alert('Unable to collect columns'); }
  }

  document.addEventListener('htmx:afterRequest', function(ev){
    if (ev.target && ev.target.id === 'saveManageForm'){
      // Show a quick toast
      try {
        const note = document.createElement('div');
        note.className = 'alert alert-success position-fixed top-0 end-0 m-3';
        note.textContent = 'Saved';
        document.body.appendChild(note);
        setTimeout(function(){ note.remove(); }, 1200);
      } catch(e){}
    }
  });
</script>
{% endblock %}
