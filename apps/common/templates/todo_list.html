{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-3">ToDo List</h2>

  <div id="todoAccordion" class="accordion">
    {% for todo in todos %}
      <div class="accordion-item mb-2" data-id="{{ todo.id }}" x-data="{ open: false }">
        <h2 class="accordion-header d-flex align-items-start">
          <span class="drag-handle px-2 text-muted" title="Drag to reorder"><i class="bi bi-grip-vertical"></i></span>
          <button class="accordion-button" :class="{ 'collapsed': !open }" type="button" @click="open = !open" :aria-expanded="open.toString()">
            <span class="me-2">{{ todo.title }}</span>
            <span class="badge rounded-pill text-bg-{{ todo.bs_class }} ms-2">{{ todo.status }}</span>
            <span class="ms-3 d-inline-flex align-items-center gap-2">
              <span class="me-1">(</span>
              {% for dep in todo.dependencies.all %}
                <span class="badge rounded-pill text-bg-{{ dep.bs_class }}">{{ dep.title }}</span>
              {% empty %}
                <span class="text-muted">No dependencies</span>
              {% endfor %}
              <span class="ms-1">)</span>
            </span>
          </button>
        </h2>
        <div class="accordion-collapse" x-show="open" x-transition>
          <div class="accordion-body">
            {{ todo.description|linebreaksbr }}
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-muted">No ToDo items available.</p>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block scripts %}
  <!-- SortableJS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script>
    (function() {
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }

      const container = document.getElementById('todoAccordion');
      if (!container) return;

      new Sortable(container, {
        animation: 150,
        handle: '.drag-handle',
        onEnd: async function() {
          const ids = Array.from(container.querySelectorAll('.accordion-item')).map(el => el.getAttribute('data-id'));
          try {
            const resp = await fetch('{% url "todo_reorder" %}', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
              },
              body: JSON.stringify({ order: ids })
            });
            if (!resp.ok) {
              console.error('Failed to reorder');
            }
          } catch (e) {
            console.error('Error reordering', e);
          }
        }
      });
    })();
  </script>
{% endblock scripts %}
