{% extends "base.html" %}
{% load dict_extras static %}

{% block title %}<title>Design - {{ layout.name }}</title>{% endblock %}

{% block content %}
<div class="container-fluid py-2">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'layout:layout_detail' username=layout.user.username slug=layout.slug %}">Back</a>
      <form id="addBlockForm" method="post" action="{% url 'layout:layout_block_add' username=layout.user.username slug=layout.slug %}" class="d-inline-flex align-items-end gap-2">
        {% csrf_token %}
        <label class="form-label mb-0">Add Block</label>
        <select name="spec_id" class="form-select form-select-sm w-auto" autocomplete="off">
          <option value="">Select a block…</option>
          {% for s in available_specs %}
            <option value="{{ s.id }}">{{ s.name }}{% if s.kind %} ({{ s.kind }}){% endif %}</option>
          {% endfor %}
        </select>
      </form>
    </div>
    {# Removed: v2 auto-saves on drag/resize, like v1 #}
  </div>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@10.1.2/dist/gridstack.min.css">
  <div class="grid-stack" id="gridDesigner"></div>
</div>

<div id="blockHtmlStore" style="display:none">
  {% for b in blocks %}
    <div id="block-html-{{ b.id }}" data-spec="{{ b.code|default:'' }}">{{ b.html|safe }}</div>
  {% endfor %}
</div>

<template id="gridItemTemplate">
  <div class="grid-stack-item" data-gs-id="" data-block-id="" data-block-kind="">
    <div class="grid-stack-item-content position-relative">
      <div class="layout-tile-controls d-flex gap-2 align-items-center">
        <span class="small text-muted js-config-summary">No defaults</span>
        <button type="button" class="btn btn-sm btn-outline-secondary js-configure">Configure</button>
        <button type="button" class="btn btn-sm btn-outline-danger js-delete">Delete</button>
      </div>
      <div class="js-html"></div>
    </div>
  </div>
</template>

<div class="modal fade" id="blockConfigModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h5 class="modal-title mb-0">Block preferences</h5>
          <div class="small text-muted js-block-config-name"></div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="small mb-3 d-none" id="blockConfigStatus"></div>
        <div class="mb-3" data-role="filter-row">
          <label class="form-label" for="blockConfigFilter">Default filter</label>
          <select class="form-select" id="blockConfigFilter"></select>
          <div class="form-text">Choose which saved filter should load by default for this block.</div>
        </div>
        <div class="mb-3" data-role="setting-row">
          <label class="form-label" for="blockConfigSetting">Default setting</label>
          <select class="form-select" id="blockConfigSetting"></select>
          <div class="form-text">Pick a saved block setting to apply to this instance.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="blockConfigSaveBtn">Save</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  {% load static %}
  <script src="{% static 'common/js/table-filters.js' %}"></script>
  <script type="application/json" id="designData">{% autoescape off %}{{ blocks_meta|tojson }}{% endautoescape %}</script>
  <script src="https://cdn.jsdelivr.net/npm/gridstack@10.1.2/dist/gridstack-all.min.js"></script>
  <script>
    (function(){
      const gridEl = document.getElementById('gridDesigner');
      const tmpl = document.getElementById('gridItemTemplate');
      const dataEl = document.getElementById('designData');
      const bootstrapLib = window.bootstrap || null;
      if (!gridEl || !tmpl || typeof GridStack === 'undefined') {
        return;
      }

      let items = [];
      try {
        items = JSON.parse((dataEl && dataEl.textContent) || '[]');
      } catch (err) {
        items = [];
      }

      const blockPrefs = new Map();
      (items || []).forEach(function(it){
        setBlockPrefs(it && it.id, {
          filter: (it && it.preferred_filter_name) || '',
          setting: (it && it.preferred_setting_name) || '',
          title: (it && (it.title || it.code)) || '',
        });
      });

      const htmlCache = new Map();
      const htmlStore = document.getElementById('blockHtmlStore');
      if (htmlStore) {
        htmlStore.querySelectorAll('[id^="block-html-"]').forEach(function(node){
          const key = node.id.replace('block-html-', '');
          htmlCache.set(key, node.innerHTML);
        });
      }

      const baseQuery = window.location.search || '';
      function buildBlockUrl(template, id) {
        const path = template.replace('/0/', '/' + String(id) + '/');
        return baseQuery ? path + baseQuery : path;
      }

      const urls = {
        save: "{% url 'layout:layout_grid_update' username=layout.user.username slug=layout.slug %}",
        add: "{% url 'layout:layout_block_add' username=layout.user.username slug=layout.slug %}",
        del: function(id) {
          return buildBlockUrl("{% url 'layout:layout_block_delete' username=layout.user.username slug=layout.slug lb_id=0 %}", id);
        },
        render: function(id) {
          return buildBlockUrl("{% url 'layout:layout_block_render' username=layout.user.username slug=layout.slug lb_id=0 %}", id);
        },
        update: function(id) {
          return buildBlockUrl("{% url 'layout:layout_block_update' username=layout.user.username slug=layout.slug lb_id=0 %}", id);
        },
        configs: function(id) {
          return buildBlockUrl("{% url 'layout:layout_block_configs' username=layout.user.username slug=layout.slug lb_id=0 %}", id);
        }
      };

      const grid = GridStack.init({
        float: false,
        staticGrid: false,
        cellHeight: 136,
        margin: 15,
        animate: true,
        disableOneColumnMode: true,
        draggable: { handle: '.grid-stack-item-content', scroll: true },
        resizable: { handles: 'e, se, s' }
      }, gridEl);
      gridEl.classList.add('grid-stack-animate');

      function getCsrfToken(){
        const form = document.getElementById('addBlockForm');
        const el = form ? form.querySelector('input[name="csrfmiddlewaretoken"]') : document.querySelector('input[name="csrfmiddlewaretoken"]');
        return (el && el.value) || '';
      }
      const csrftoken = getCsrfToken();

      const configModalEl = document.getElementById('blockConfigModal');
      const configFilterSelect = document.getElementById('blockConfigFilter');
      const configSettingSelect = document.getElementById('blockConfigSetting');
      const configStatusEl = document.getElementById('blockConfigStatus');
      const configSaveBtn = document.getElementById('blockConfigSaveBtn');
      const configNameEl = configModalEl ? configModalEl.querySelector('.js-block-config-name') : null;
      const filterRow = configModalEl ? configModalEl.querySelector('[data-role="filter-row"]') : null;
      const settingRow = configModalEl ? configModalEl.querySelector('[data-role="setting-row"]') : null;
      const configModal = (configModalEl && bootstrapLib && typeof bootstrapLib.Modal === 'function') ? new bootstrapLib.Modal(configModalEl) : null;
      let currentConfigBlockId = null;
      let currentConfigButton = null;
      let currentConfigData = null;

      function showToast(message, variant) {
        const id = 'layout-toast-container';
        let container = document.getElementById(id);
        if (!container) {
          container = document.createElement('div');
          container.id = id;
          container.style.position = 'fixed';
          container.style.right = '16px';
          container.style.bottom = '16px';
          container.style.zIndex = '1080';
          container.style.display = 'flex';
          container.style.flexDirection = 'column';
          container.style.gap = '8px';
          document.body.appendChild(container);
        }
        const el = document.createElement('div');
        el.textContent = message || 'An error occurred';
        el.style.padding = '10px 14px';
        el.style.borderRadius = '4px';
        el.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
        el.style.color = '#fff';
        el.style.fontSize = '14px';
        el.style.opacity = '0';
        el.style.transition = 'opacity .2s ease';
        el.style.background = variant === 'success' ? '#198754' : variant === 'warning' ? '#fd7e14' : '#dc3545';
        container.appendChild(el);
        requestAnimationFrame(function(){ el.style.opacity = '1'; });
        setTimeout(function(){
          el.style.opacity = '0';
          setTimeout(function(){ el.remove(); }, 200);
        }, 3200);
      }

      function getBlockPrefs(id) {
        if (id === undefined || id === null) {
          return { filter: '', setting: '', title: '' };
        }
        const key = String(id);
        return blockPrefs.get(key) || { filter: '', setting: '', title: '' };
      }

      function setBlockPrefs(id, updates) {
        if (id === undefined || id === null) {
          return { filter: '', setting: '', title: '' };
        }
        const key = String(id);
        const existing = blockPrefs.get(key) || { filter: '', setting: '', title: '' };
        const next = Object.assign({}, existing, updates || {});
        blockPrefs.set(key, next);
        return next;
      }

      function formatPrefSummary(prefs) {
        const parts = [];
        if (prefs && prefs.filter) {
          parts.push(`Filter: ${prefs.filter}`);
        }
        if (prefs && prefs.setting) {
          parts.push(`Setting: ${prefs.setting}`);
        }
        return parts;
      }

      function updateConfigSummary(root, id) {
        if (!root) { return; }
        const prefs = getBlockPrefs(id);
        const summaryEl = root.querySelector('.js-config-summary');
        if (summaryEl) {
          const parts = formatPrefSummary(prefs);
          summaryEl.textContent = parts.length ? parts.join(' • ') : 'No defaults';
        }
        const btn = root.querySelector('.js-configure');
        if (btn) {
          const parts = formatPrefSummary(prefs);
          if (parts.length) {
            btn.setAttribute('title', parts.join('\n'));
          } else {
            btn.setAttribute('title', 'Configure filter & setting');
          }
          btn.dataset.blockId = String(id);
        }
        root.dataset.prefFilter = prefs.filter || '';
        root.dataset.prefSetting = prefs.setting || '';
      }

      function populateSelect(select, options, selectedValue) {
        if (!select) { return; }
        const desired = typeof selectedValue === 'string' ? selectedValue : (selectedValue == null ? '' : String(selectedValue));
        select.innerHTML = '';
        const baseOption = document.createElement('option');
        baseOption.value = '';
        baseOption.textContent = '(None)';
        select.appendChild(baseOption);
        const seen = new Set();
        (options || []).forEach(function(name){
          if (!name || seen.has(name)) { return; }
          seen.add(name);
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });
        if (desired && !seen.has(desired)) {
          const opt = document.createElement('option');
          opt.value = desired;
          opt.textContent = `${desired} (not found)`;
          opt.disabled = true;
          opt.selected = true;
          select.appendChild(opt);
        } else {
          select.value = desired || '';
        }
      }

      function openConfigModal(id, trigger) {
        if (!id && id !== 0) { return; }
        if (!configModal) {
          showToast('Unable to open preferences dialog', 'error');
          return;
        }
        currentConfigBlockId = id;
        currentConfigButton = trigger || null;
        currentConfigData = null;
        if (configSaveBtn) { configSaveBtn.disabled = true; }
        if (configStatusEl) {
          configStatusEl.textContent = 'Loading…';
          configStatusEl.classList.remove('text-danger');
          configStatusEl.classList.remove('d-none');
          configStatusEl.classList.add('text-muted');
        }
        if (configFilterSelect) {
          populateSelect(configFilterSelect, [], getBlockPrefs(id).filter);
          configFilterSelect.disabled = true;
        }
        if (configSettingSelect) {
          populateSelect(configSettingSelect, [], getBlockPrefs(id).setting);
          configSettingSelect.disabled = true;
        }
        if (filterRow) { filterRow.classList.add('d-none'); }
        if (settingRow) { settingRow.classList.add('d-none'); }
        if (configNameEl) {
          const prefs = getBlockPrefs(id);
          configNameEl.textContent = prefs.title || '';
        }
        try {
          configModal.show();
        } catch (err) {
          showToast('Unable to open preferences dialog', 'error');
          return;
        }
        fetch(urls.configs(id), {
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
          }
        }).then(function(resp){
          if (!resp.ok) { throw new Error('Failed to load options'); }
          return resp.json().catch(function(){ return {}; });
        }).then(function(data){
          currentConfigData = data || {};
          const prefs = getBlockPrefs(id);
          const selected = (data && data.selected) || {};
          const filters = Array.isArray(data && data.filters) ? data.filters : [];
          const settings = Array.isArray(data && data.settings) ? data.settings : [];
          if (configFilterSelect) {
            populateSelect(configFilterSelect, filters, prefs.filter || selected.filter || '');
            configFilterSelect.disabled = false;
          }
          if (configSettingSelect) {
            const desiredSetting = prefs.setting || selected.setting || selected.column || '';
            populateSelect(configSettingSelect, settings, desiredSetting);
            configSettingSelect.disabled = false;
          }
          if (filterRow) { filterRow.classList.toggle('d-none', filters.length === 0); }
          if (settingRow) { settingRow.classList.toggle('d-none', settings.length === 0); }
          if (configStatusEl) {
            if (!filters.length && !settings.length) {
              configStatusEl.textContent = 'No saved filters or settings were found for this block yet.';
              configStatusEl.classList.remove('text-danger');
              configStatusEl.classList.remove('d-none');
              configStatusEl.classList.add('text-muted');
            } else {
              configStatusEl.textContent = '';
              configStatusEl.classList.add('d-none');
            }
          }
        }).catch(function(err){
          if (configStatusEl) {
            configStatusEl.textContent = (err && err.message) ? err.message : 'Unable to load block preferences.';
            configStatusEl.classList.remove('text-muted');
            configStatusEl.classList.remove('d-none');
            configStatusEl.classList.add('text-danger');
          }
          if (configFilterSelect) {
            configFilterSelect.disabled = false;
            populateSelect(configFilterSelect, [], getBlockPrefs(id).filter);
          }
          if (configSettingSelect) {
            configSettingSelect.disabled = false;
            populateSelect(configSettingSelect, [], getBlockPrefs(id).setting);
          }
        }).finally(function(){
          if (configSaveBtn) { configSaveBtn.disabled = false; }
        });
      }

      function executeScripts(scope){
        if (!scope || !scope.querySelectorAll) { return; }
        scope.querySelectorAll('script').forEach(function(oldScript){
          const replacement = document.createElement('script');
          for (const attr of oldScript.attributes || []) {
            replacement.setAttribute(attr.name, attr.value);
          }
          replacement.text = oldScript.text || oldScript.textContent || '';
          oldScript.replaceWith(replacement);
        });
      }

      function hydrateBlock(wrapper, id){
        if (!wrapper || !id) { return; }
        fetch(urls.render(id), {
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
          }
        }).then(function(resp){
          if (!resp.ok) { throw new Error('Failed to load block'); }
          return resp.json().catch(function(){ return {}; });
        }).then(function(payload){
          if (!payload || typeof payload.html !== 'string') { return; }
          htmlCache.set(String(id), payload.html);
          wrapper.innerHTML = payload.html;
          executeScripts(wrapper);
          const root = wrapper.closest('.grid-stack-item');
          normalizeCardForDesign(root);
          if (payload && payload.block && payload.block.id !== undefined) {
            const blockId = payload.block.id;
            const existingPrefs = getBlockPrefs(blockId);
            const nextPrefs = setBlockPrefs(blockId, {
              title: payload.block.title || payload.block.code || existingPrefs.title || '',
              filter: payload.block.preferred_filter_name || existingPrefs.filter || '',
              setting: payload.block.preferred_setting_name || existingPrefs.setting || '',
            });
            updateConfigSummary(root, blockId);
            if (root) {
              root.dataset.blockId = String(blockId);
              if (payload.block.kind) {
                root.dataset.blockKind = payload.block.kind;
              }
              root.dataset.prefFilter = nextPrefs.filter || '';
              root.dataset.prefSetting = nextPrefs.setting || '';
            }
          }
        }).catch(function(){ /* ignore hydration errors */ });
      }

      function saveGrid(){
        const payload = [];
        const nodes = (grid && grid.engine && grid.engine.nodes) || [];
        nodes.forEach(function(node){
          const nodeEl = node.el || null;
          const id = nodeEl && nodeEl.dataset ? nodeEl.dataset.gsId : node.id;
          if (!id) { return; }
          payload.push({ id: String(id), x: node.x, y: node.y, w: node.w, h: node.h });
        });
        fetch(urls.save, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrftoken,
            'Accept': 'application/json'
          },
          body: JSON.stringify({ items: payload })
        }).catch(function(){ /* ignore */ });
      }

      let saveDebounce;
      grid.on('change', function(){
        clearTimeout(saveDebounce);
        saveDebounce = setTimeout(saveGrid, 150);
      });

      function normalizeCardForDesign(root){
        if (!root) { return; }
        try {
          const htmlRoot = root.querySelector('.js-html');
          if (htmlRoot) {
            htmlRoot.style.display = 'flex';
            htmlRoot.style.flexDirection = 'column';
            htmlRoot.style.width = '100%';
          }
          const card = root.querySelector('.js-html .card');
          if (card) {
            card.style.height = '100%';
            card.style.width = '100%';
          }
          const body = root.querySelector('.js-html .card-body');
          if (body) {
            body.style.display = 'flex';
            body.style.flexDirection = 'column';
            body.style.height = '100%';
          }
          const tableEl = root.querySelector('.js-html [id$="-table"]');
          if (tableEl) {
            tableEl.style.height = '100%';
            tableEl.style.minHeight = '0';
          }
        } catch (err) {
          /* ignore */
        }
      }

      function attachDeleteHandler(root, id){
        if (!root) { return; }
        const btn = root.querySelector('.js-delete');
        if (!btn) { return; }
        btn.addEventListener('click', function(){
          if (!confirm('Delete this block?')) { return; }
          fetch(urls.del(id), {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': csrftoken,
              'Accept': 'application/json'
            }
          }).then(function(resp){
            if (resp.ok) {
              try {
                grid.removeWidget(root);
              } catch (err) {
                root.remove();
              }
              blockPrefs.delete(String(id));
              showToast('Block removed', 'success');
              saveGrid();
            } else {
              showToast('Delete failed', 'error');
            }
          }).catch(function(){
            showToast('Delete failed', 'error');
          });
        });
      }

      function attachConfigureHandler(root, id){
        if (!root) { return; }
        const btn = root.querySelector('.js-configure');
        if (!btn) { return; }
        btn.dataset.blockId = String(id);
        btn.addEventListener('click', function(){
          const targetId = btn.dataset.blockId ? parseInt(btn.dataset.blockId, 10) : id;
          openConfigModal(targetId, btn);
        });
        updateConfigSummary(root, id);
      // Save header \"View\"/\"Filter\" changes to LayoutBlock without blocking navigation
      (function attachHeaderAutoPersist(){
        const container = document.getElementById('gridDesigner');
        if (!container) { return; }
        container.addEventListener('change', function(ev){
          const sel = ev.target && ev.target.closest && ev.target.closest('.js-html .card-header select.form-select');
          if (!sel) { return; }
          const isFilter = sel.id && sel.id.indexOf('filterCfgSelect-') === 0;
          const prefField = isFilter ? 'preferred_filter_name' : 'preferred_setting_name';
          const tile = sel.closest('.grid-stack-item');
          const idStr = tile && (tile.getAttribute('data-gs-id') || tile.getAttribute('data-block-id'));
          const lbId = idStr ? parseInt(idStr, 10) : NaN;
          if (!Number.isFinite(lbId)) { return; }
          var text = '';
          try { text = (sel.options && sel.selectedIndex >= 0 && sel.options[sel.selectedIndex] && sel.options[sel.selectedIndex].text) || ''; } catch (e) { text = ''; }
          var cleaned = text.replace(/\s*\(default\)\s*$/i, '').trim();
          const form = new URLSearchParams();
          form.append(prefField, cleaned);
          form.append('csrfmiddlewaretoken', csrftoken || '');
          try {
            const blob = new Blob([form.toString()], { type: 'application/x-www-form-urlencoded; charset=UTF-8' });
            if (navigator && typeof navigator.sendBeacon === 'function') {
              const url = (typeof urls.update === 'function') ? urls.update(lbId) : urls.update;
              navigator.sendBeacon(url, blob);
              return;
            }
          } catch (_) { /* fallthrough */ }
          const url2 = (typeof urls.update === 'function') ? urls.update(lbId) : urls.update;
          fetch(url2, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8', 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken },
            body: form.toString(),
            keepalive: true,
          }).catch(function(){ /* ignore */ });
        });
      })();
      }

      if (configModalEl && configModalEl.addEventListener) {
        configModalEl.addEventListener('hidden.bs.modal', function(){
          currentConfigBlockId = null;
          currentConfigButton = null;
          currentConfigData = null;
          if (configStatusEl) {
            configStatusEl.textContent = '';
            configStatusEl.classList.add('d-none');
            configStatusEl.classList.remove('text-danger');
            configStatusEl.classList.remove('text-muted');
          }
          if (configFilterSelect) {
            populateSelect(configFilterSelect, [], '');
            configFilterSelect.disabled = false;
          }
          if (configSettingSelect) {
            populateSelect(configSettingSelect, [], '');
            configSettingSelect.disabled = false;
          }
        });
      }

      if (configSaveBtn) {
        configSaveBtn.addEventListener('click', function(){
          if (currentConfigBlockId === null || currentConfigBlockId === undefined) {
            if (configModal) { configModal.hide(); }
            return;
          }
          const formData = new URLSearchParams();
          if (configFilterSelect) {
            formData.append('preferred_filter_name', configFilterSelect.value || '');
          }
          if (configSettingSelect) {
            formData.append('preferred_setting_name', configSettingSelect.value || '');
          }
          configSaveBtn.disabled = true;
          fetch(urls.update(currentConfigBlockId), {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': csrftoken,
              'Accept': 'application/json'
            },
            body: formData.toString()
          }).then(function(resp){
            if (!resp.ok) { throw new Error('Failed to save preferences'); }
          }).then(function(){
            const nextPrefs = setBlockPrefs(currentConfigBlockId, {
              filter: configFilterSelect ? (configFilterSelect.value || '') : '',
              setting: configSettingSelect ? (configSettingSelect.value || '') : '',
            });
            if (currentConfigButton) {
              const root = currentConfigButton.closest('.grid-stack-item');
              updateConfigSummary(root, currentConfigBlockId);
              if (root) {
                root.dataset.prefFilter = nextPrefs.filter || '';
                root.dataset.prefSetting = nextPrefs.setting || '';
              }
            }
            showToast('Preferences saved', 'success');
            if (configModal) { configModal.hide(); }
          }).catch(function(err){
            const message = (err && err.message) ? err.message : 'Failed to save block preferences';
            showToast(message, 'error');
            if (configStatusEl) {
              configStatusEl.textContent = message;
              configStatusEl.classList.remove('text-muted');
              configStatusEl.classList.remove('d-none');
              configStatusEl.classList.add('text-danger');
            }
          }).finally(function(){
            if (configSaveBtn) { configSaveBtn.disabled = false; }
          });
        });
      }

      function resolveHtml(id, fallback){
        if (typeof fallback === 'string' && fallback.length) {
          htmlCache.set(String(id), fallback);
          return fallback;
        }
        const cached = htmlCache.get(String(id));
        return typeof cached === 'string' ? cached : '';
      }

      function addItem(item, opts){
        if (!item) { return null; }
        opts = opts || {};
        const root = tmpl.content.firstElementChild.cloneNode(true);
        root.dataset.gsId = String(item.id);
        const htmlWrap = root.querySelector('.js-html');
        const html = resolveHtml(item.id, item.html);
        if (htmlWrap) {
          if (typeof html === 'string' && html.length) {
            htmlWrap.innerHTML = html;
            executeScripts(htmlWrap);
            htmlCache.set(String(item.id), html);
          } else {
            htmlWrap.innerHTML = '<div class="text-muted small">No preview available</div>';
          }
        }
        setBlockPrefs(item.id, {
          filter: (item && item.preferred_filter_name) || '',
          setting: (item && item.preferred_setting_name) || '',
          title: (item && (item.title || item.code)) || '',
        });
        const added = grid.addWidget(root, {
          x: Number.isFinite(item.x) ? item.x : 0,
          y: Number.isFinite(item.y) ? item.y : 0,
          w: Number.isFinite(item.w) ? item.w : 4,
          h: Number.isFinite(item.h) ? item.h : 2,
          id: String(item.id)
        });
        const element = added && added.el ? added.el : (added instanceof HTMLElement ? added : root);
        if (element) {
          element.dataset.blockId = String(item.id);
          element.dataset.blockKind = item.kind || '';
          element.dataset.prefFilter = (item && item.preferred_filter_name) || '';
          element.dataset.prefSetting = (item && item.preferred_setting_name) || '';
        }
        normalizeCardForDesign(element);
        attachDeleteHandler(element, item.id);
        attachConfigureHandler(element, item.id);
        const shouldHydrate = Object.prototype.hasOwnProperty.call(opts, 'hydrate') ? opts.hydrate : !(typeof html === 'string' && html.length);
        if (shouldHydrate && htmlWrap) {
          hydrateBlock(htmlWrap, item.id);
        }
        if (opts && opts.focus && element && element.scrollIntoView) {
          requestAnimationFrame(function(){ element.scrollIntoView({ behavior: 'smooth', block: 'center' }); });
        }
        return element;
      }

      if (typeof grid.batchUpdate === 'function') {
        grid.batchUpdate();
      }
      (items || []).forEach(function(it){
        addItem(it, { hydrate: false });
      });
      if (typeof grid.commit === 'function') {
        grid.commit();
      }

      const addForm = document.getElementById('addBlockForm');
      if (addForm) {
        addForm.addEventListener('submit', function(evt){ evt.preventDefault(); });
        const select = addForm.querySelector('select[name="spec_id"]');
        if (select) {
          select.addEventListener('change', function(){
            const specId = this.value;
            if (!specId) { return; }
            const self = this;
            self.disabled = true;
            addForm.classList.add('is-loading');
            fetch(urls.add, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken,
                'Accept': 'application/json'
              },
              body: JSON.stringify({ spec_id: specId })
            }).then(function(resp){
              return resp.json().catch(function(){ return {}; }).then(function(payload){
                if (!resp.ok || !payload.ok || !payload.block) {
                  const errMsg = payload.error || 'Failed to add block.';
                  throw new Error(errMsg);
                }
                return payload.block;
              });
            }).then(function(block){
              addItem(block, { focus: true, hydrate: true });
              showToast('Block added', 'success');
              saveGrid();
            }).catch(function(err){
              const msg = err && err.message ? err.message : 'Failed to add block.';
              showToast(msg, 'error');
            }).finally(function(){
              addForm.classList.remove('is-loading');
              self.disabled = false;
              self.value = '';
            });
          });
        }
      }
    })();
  </script>
  <style>
    .grid-stack{ min-height: 70vh; }
    /* Make embedded cards match tile height and keep resizer at bottom-right */
    #gridDesigner .grid-stack-item{ overflow: visible; min-height: 0; }
    #gridDesigner .grid-stack-item-content{ height:100%; display:flex; width:100%; overflow: visible; padding: 0.5rem; box-sizing: border-box; }
    #gridDesigner .grid-stack-item-content .js-html{ flex:1 1 auto; display:flex; flex-direction:column; width:100%; }
    #gridDesigner .grid-stack-item-content .js-html .card{ height:100%; width:100%; }
    #gridDesigner .grid-stack-item-content .js-html .card{ margin: 0; }
    #gridDesigner .grid-stack-item-content .js-html .card-body{ height:100%; display:flex; flex-direction:column; }
    #gridDesigner .grid-stack-item-content .js-html [id$='-table']{ height:100% !important; min-height:0; }
    #gridDesigner .layout-tile-controls{
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 2;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      flex-wrap: wrap;
      padding: 0.25rem 0.35rem;
      border-radius: 999px;
      background-color: rgba(248, 249, 250, 0.95);
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.08);
    }
    #gridDesigner .layout-tile-controls .btn{
      white-space: nowrap;
    }
    #gridDesigner .layout-tile-controls .js-config-summary{
      max-width: 220px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #gridDesigner .js-html > *{ height:100%; width:100%; flex: 1 1 auto; }
    /* Nudge Gridstack resize handle inside the tile for both legacy and v10 classes */
    #gridDesigner .grid-stack-item .ui-resizable-se,
    #gridDesigner .grid-stack-item .ui-resizable-handle,
    #gridDesigner .grid-stack-item .gs-resize-handle,
    #gridDesigner .grid-stack-item .gs-resize-handle-both{
      right: 4px !important;
      bottom: 4px !important;
    }
    #addBlockForm.is-loading{
      position: relative;
    }
    #addBlockForm.is-loading select{
      pointer-events: none;
      opacity: 0.65;
    }
    #addBlockForm.is-loading::after{
      content: '';
      position: absolute;
      right: -18px;
      bottom: 6px;
      width: 0.85rem;
      height: 0.85rem;
      border-radius: 50%;
      border: 2px solid rgba(0,0,0,0.2);
      border-top-color: rgba(0,0,0,0.55);
      animation: layout-spin 0.6s linear infinite;
    }
    @keyframes layout-spin {
      to { transform: rotate(360deg); }
    }
  </style>
{% endblock %}
