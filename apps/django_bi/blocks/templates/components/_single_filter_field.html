{% load dict_extras %}
{% with val=initial_values|get_item:key cfg=filter_schema|get_item:key %}
  {% if not cfg %}
    {# Unknown key; skip #}
  {% else %}
    <div class="mb-4 filter-field">
      {% if cfg.type == 'select' %}
        <label class="form-label">{{ cfg.label }}</label>
        <select class="form-select filter-field-select" name="{{ name_prefix|default:'filters.' }}{{ key }}"{% if cfg.choices_url %} data-ajax-url="{{ cfg.choices_url }}"{% endif %}{% if cfg.tom_select_options %} data-tom-select-options='{{ cfg.tom_select_options|tojson }}'{% endif %}>
          <option value="">-- Any --</option>
          {% if not cfg.choices_url %}
            {% for v, lbl in cfg.choices %}
              <option value="{{ v }}" {% if val|stringformat:"s" == v|stringformat:"s" %}selected{% endif %}>{{ lbl }}</option>
            {% endfor %}
          {% elif val %}
            <option value="{{ val }}" selected>{{ val }}</option>
          {% endif %}
        </select>
      {% elif cfg.type == 'multiselect' %}
        <label class="form-label">{{ cfg.label }}</label>
        <select class="form-select filter-field-select" name="{{ name_prefix|default:'filters.' }}{{ key }}" multiple{% if cfg.choices_url %} data-ajax-url="{{ cfg.choices_url }}"{% endif %}{% if cfg.tom_select_options %} data-tom-select-options='{{ cfg.tom_select_options|tojson }}'{% endif %}>
          {% if not cfg.choices_url %}
            {% for v, lbl in cfg.choices %}
              <option value="{{ v }}" {% if val and v in val %}selected{% endif %}>{{ lbl }}</option>
            {% endfor %}
          {% elif val %}
            {% for v in val %}
              <option value="{{ v }}" selected>{{ v }}</option>
            {% endfor %}
          {% else %}
            <option value=""></option>
          {% endif %}
        </select>
        <div class="form-text">Hold Ctrl/Cmd to select multiple.</div>
      {% elif cfg.type == 'number' %}
        <label class="form-label">{{ cfg.label }}</label>
        <input type="number" class="form-control" name="{{ name_prefix|default:'filters.' }}{{ key }}" value="{{ val|default:'' }}"/>
      {% elif cfg.type == 'date' %}
        <label class="form-label">{{ cfg.label }}</label>
        <div class="date-filter-wrapper" data-key="{{ key }}">
          <div class="d-flex gap-2 align-items-start flex-wrap">
            <input type="text" class="form-control date-token-input" style="min-width: 220px;" name="{{ name_prefix|default:'filters.' }}{{ key }}" value="{{ val|default:'' }}" placeholder="YYYY-MM-DD or token"/>
            <div>
              <button class="btn btn-outline-secondary btn-sm pick-date-btn" type="button">Pick Date</button>
              <input type="date" class="date-picker" style="position:absolute;opacity:0;width:0;height:0;pointer-events:none;" tabindex="-1" aria-hidden="true"/>
            </div>
            <select class="form-select form-select-sm date-quick-select" style="min-width: 200px;">
              <option value="">Quick pickâ€¦</option>
              <option value="__today__">Today</option>
              <option value="__start_of_month__">Start of Month</option>
              <option value="__end_of_month__">End of Month</option>
              <option value="__start_of_quarter__">Start of Quarter</option>
              <option value="__end_of_quarter__">End of Quarter</option>
              <option value="__start_of_year__">Start of Year</option>
              <option value="__end_of_year__">End of Year</option>
              <option value="__current_fiscal_year_start__">Current FY Start</option>
              <option value="__current_fiscal_year_end__">Current FY End</option>
            </select>
          </div>
        </div>
      {% elif cfg.type == 'boolean' %}
        <label class="form-label">{{ cfg.label }}</label>
        <div class="form-check">
          <input type="checkbox" class="form-check-input" id="{{ id_prefix|default:'' }}-filters_{{ key }}" name="{{ name_prefix|default:'filters.' }}{{ key }}" value="1" {% if val %}checked{% endif %}>
          <label class="form-check-label" for="{{ id_prefix|default:'' }}-filters_{{ key }}">Yes</label>
        </div>
      {% else %}
        <label class="form-label">{{ cfg.label }}</label>
        <input type="text" class="form-control" name="{{ name_prefix|default:'filters.' }}{{ key }}" value="{{ val|default:'' }}"/>
      {% endif %}
      {% if cfg.help %}
        <div class="form-text">{{ cfg.help }}</div>
      {% endif %}
    </div>
  {% endif %}
{% endwith %}

