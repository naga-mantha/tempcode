V2 Table Rewrite — Progress and Next Steps

Scope: Finish the new V2 foundations and fully nail the Table block (services, policy, configs, filters, exports). Layout/content blocks are deferred until the table is complete.

Progress
- V2 scaffolding
  - apps_v2 namespace; versioned mounts at `/blocks/v2/` and `/layouts/v2/`.
  - PolicyService stub (permissive). Serializer masks unreadable fields when policy denies.
  - BlockSpec + in‑memory registry; idempotent `load_specs()`; management command `sync_blocks_v2`.
- Exemplar Table (Layouts)
  - Services: FilterResolver, ColumnResolver, QueryBuilder, Serializer wired via a generic BlockController.
  - Tabulator front‑end with remote pagination/sorting; validated server data endpoint `/blocks/v2/data/<spec_id>`.
  - Policy masking in Serializer; row scoping via `policy.filter_queryset()`.
  - Safe Column Catalog with types and relation depth (0–3), policy‑pruned.
- Configs and UX
  - Saved Table Views (columns + allowlisted options groundwork): save/select, rename/duplicate/delete, make‑default, toggle visibility.
  - Manage Columns page (SortableJS): available vs selected lists, search, type badges, depth selector.
  - Allowlisted Tabulator options merged from spec → view → GET overrides.
- Filters
  - Saved Filters (reuse BlockFilterConfig) with FilterResolver.clean() validation.
  - Filter UI: visibility, name (icontains), categories (Tom Select multi‑select).
  - Dependent choices endpoint `/blocks/v2/choices/<spec_id>/<field>` (category) with narrowing based on other filters.
- Exports
  - Server‑side CSV/XLSX export honoring view ordering and filters (`/blocks/v2/export/<spec_id>.(csv|xlsx)`).
  - Client‑side CSV/XLSX/PDF still available via Tabulator.
- Hardening
  - Data API validation (4xx on bad sort/dir/page/size), stable secondary sort by `pk`.
  - Reset button matches V1 (reload base URL). Refresh removed per request.

Next Steps (Table‑focused)
1) Filters & Schema
   - Add date/date‑range types (inputs + resolver validation). Choose model/date fields: add timestamps on Layout or switch exemplar to a model with dates.
   - Extend choices endpoint for additional fields; unify dependent narrowing pattern.
   - Optional: static enum choices support in resolver (allow/deny lists).

2) Options & Views
   - Expose allowlisted Tabulator options in “Save View” (pagination size, layout, movableColumns, etc.).
   - Import from V1 views where feasible (mapping of fields/options).

3) Policy Integration
   - Wire real PolicyService behind a rollout flag (wrap existing permissions/workflow).
   - Add FK choice scoping stubs (for future FormBlock) and ensure masking shadow‑runs before enforce.

4) Server Exports
   - PDF (WeasyPrint) for large datasets, behind a feature flag; basic audit (who/when/spec/filters/row_count).

5) UX polish
   - Standard error toasts for 4xx from data endpoint; spinner/empty/error states consolidation.
   - Toolbar: optional “Reset View” (clear `config_id`) and quick “Set Default” action from header.

6) Tests & Telemetry
   - Unit: FilterResolver.clean(), QueryBuilder (filters/sorts/limits), ColumnResolver (policy pruning), options merge.
   - API: data endpoint pagination/sort/error paths; choices endpoint; export responses.
   - Telemetry: per‑block render time, row counts; export metrics.

Open Questions / Decisions Needed
- Date fields source for exemplar (add to Layout vs choose a data model with dates).
- Allowlist for Tabulator options: confirm the exact set to expose in V2 UI.
- Timeline for enabling real PolicyService (shadow → enforce) and rollout strategy.

How to Resume
- Pick “Filters & Schema → Add date/date‑range” and implement for the chosen date fields.
- Or proceed with “Options & Views → expose allowlisted options in Save View” if dates are pending a model decision.
V2 Table Rewrite — Progress and Next Steps

Scope: Finish the new V2 foundations and fully nail the Table block (services, policy, configs, filters, exports). Layout/content blocks are deferred until the table is complete.

Progress
- V2 scaffolding
  - apps_v2 namespace; versioned mounts at `/blocks/v2/` and `/layouts/v2/`.
  - PolicyService stub (permissive). Serializer masks unreadable fields when policy denies.
  - BlockSpec + in‑memory registry; idempotent `load_specs()`; management command `sync_blocks_v2`.
- Exemplar Table (Layouts)
  - Services: FilterResolver, ColumnResolver, QueryBuilder, Serializer wired via a generic BlockController.
  - Tabulator frontend with remote pagination/sorting; validated server data endpoint `/blocks/v2/data/<spec_id>`.
  - Policy masking in Serializer; row scoping via `policy.filter_queryset()`.
  - Safe Column Catalog with types and relation depth (0‑3), policy‑pruned.
- Configs and UX
  - Saved Table Views (columns + allowlisted options groundwork): save/select, rename/duplicate/delete, make‑default, toggle visibility.
  - Manage Columns page (SortableJS): available vs selected lists, search, type badges, depth selector.
  - Allowlisted Tabulator options merged from spec + view + GET overrides.
- Filters
  - Saved Filters (reuse BlockFilterConfig) with FilterResolver.clean() validation.
  - Filter UI: visibility, name (icontains), categories (Tom Select multi‑select).
  - Dependent choices endpoint `/blocks/v2/choices/<spec_id>/<field>` (category) with narrowing based on other filters.
- Exports
  - Server‑side CSV/XLSX export honoring view ordering and filters (`/blocks/v2/export/<spec_id>.(csv|xlsx)`).
  - Client‑side CSV/XLSX/PDF still available via Tabulator.
- Hardening
  - Data API validation (4xx on bad sort/dir/page/size), stable secondary sort by `pk`.
  - Reset button matches V1 (reload base URL). Refresh removed per request.

Next Steps (Table‑focused)
1) Filters & Schema
   - Add date/date‑range types (inputs + resolver validation). Choose model/date fields: add timestamps on Layout or switch exemplar to a model with dates.
   - Extend choices endpoint for additional fields; unify dependent narrowing pattern.
   - Optional: static enum choices support in resolver (allow/deny lists).

2) Options & Views
   - Expose allowlisted Tabulator options in “Save View” (pagination size, layout, movableColumns, etc.).
   - Import from V1 views where feasible (mapping of fields/options).

3) Policy Integration
   - Wire real PolicyService behind a rollout flag (wrap existing permissions/workflow).
   - Add FK choice scoping stubs (for future FormBlock) and ensure masking shadow‑runs before enforce.

4) Server Exports
   - PDF (WeasyPrint) for large datasets, behind a feature flag; basic audit (who/when/spec/filters/row_count).

5) UX polish
   - Standard error toasts for 4xx from data endpoint; spinner/empty/error states consolidation.
   - Toolbar: optional “Reset View” (clear `config_id`) and quick “Set Default” action from header.

6) Tests & Telemetry
   - Unit: FilterResolver.clean(), QueryBuilder (filters/sorts/limits), ColumnResolver (policy pruning), options merge.
   - API: data endpoint pagination/sort/error paths; choices endpoint; export responses.
   - Telemetry: per‑block render time, row counts; export metrics.

Open Questions / Decisions Needed
- Date fields source for exemplar (add to Layout vs choose a data model with dates).
- Allowlist for Tabulator options: confirm the exact set to expose in V2 UI.
- Timeline for enabling real PolicyService (shadow + enforce) and rollout strategy.

How to Resume
- Pick “Filters & Schema + Add date/date‑range” and implement for the chosen date fields.
- Or proceed with “Options & Views + expose allowlisted options in Save View” if dates are pending a model decision.


----------------------------------------

Status Update (current sprint)

Implemented (generic, schema‑driven)
- Services: schema‑driven FilterResolver (`spec.filter_schema`), ModelQueryBuilder (with PolicyService row scoping), ModelColumnResolver (policy‑pruned catalog with `column_allow/deny/max_depth`), ModelSerializer (relation path support, policy mask).
- BlockSpec extended with `model`, `filter_schema`, `column_allow/deny`, `column_max_depth`, `table_options`.
- Endpoints: render_spec (partial), data_spec (remote pagination with `{data,page,size,total,last_page}` and `select_related` for relation columns), choices_spec (generic distinct choices), export_spec (CSV/XLSX honoring view + filters + sort).
- UI: dynamic filter form from schema (no hard‑coding), TomSelect multiselects, Apply button + Enter to submit, auto‑submit on selects/dates/multiselects.
- Toolbar: Save View (columns + allowlisted options), Reset View (clears `config_id`), Reset Filters, server/client exports.
- Manage Columns: drag/drop Available ↔ Selected, reorder, save per‑view; rename/duplicate/delete/make‑default; respects FieldDisplayRule + policy pruning.
- Field Display: FieldDisplayRule exclusions hide fields and prevent traversal through excluded FKs; seeding via `set_field_display_exclusions`.
- Demo Specs: `v2.items.table` and `v2.layouts.table` now use the generic services.

Performance
- Remote pagination fetches only the current page; initial render skips server‑side serialization for remote tables; `select_related` reduces per‑row lookups for relation columns.

Where we left off / Next up
- Completed: Save View Options (layout, paginationSize, movableColumns) persisted and merged (spec → saved → GET).
- Next:
  1) Tests: resolver.clean, options merge; data endpoint pagination/sort/last_page; choices; exports.
  2) Choices polish: light caching + min query length per field.
  3) Date tokens in resolver clean: `__today__`, `__start_of_month__`, etc.
  4) Import V1 views → V2 (columns + options) for selected blocks.
  5) PDF export behind feature flag + basic export audit metadata.
  6) Policy rollout: shadow‑run logging then enforce, with tests.

How to resume now
- Start with the Tests milestone to lock behavior; or implement date tokens + choices polish for immediate UX wins.

